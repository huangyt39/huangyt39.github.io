<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Blogs of learning CS">
<meta property="og:type" content="website">
<meta property="og:title" content="MyBlog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="MyBlog">
<meta property="og:description" content="Blogs of learning CS">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MyBlog">
<meta name="twitter:description" content="Blogs of learning CS">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>MyBlog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">MyBlog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/06/MapReduce笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huangyt">
      <meta itemprop="description" content="Blogs of learning CS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/06/MapReduce笔记/" class="post-title-link" itemprop="url">MapReduce笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-06 22:05:24" itemprop="dateCreated datePublished" datetime="2020-08-06T22:05:24+08:00">2020-08-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-14 11:53:28" itemprop="dateModified" datetime="2020-09-14T11:53:28+08:00">2020-09-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式/" itemprop="url" rel="index"><span itemprop="name">分布式</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MapReduce-笔记"><a href="#MapReduce-笔记" class="headerlink" title="MapReduce 笔记"></a>MapReduce 笔记</h1><p><a href="http://nil.csail.mit.edu/6.824/2020/papers/mapreduce.pdf" target="_blank" rel="noopener">http://nil.csail.mit.edu/6.824/2020/papers/mapreduce.pdf</a></p>
<h2 id="1-编程模式"><a href="#1-编程模式" class="headerlink" title="1 编程模式"></a>1 编程模式</h2><h3 id="1-1-基本组成"><a href="#1-1-基本组成" class="headerlink" title="1.1 基本组成"></a>1.1 基本组成</h3><ul>
<li>Map 将输入处理为中间 key-value 集合，MapReduce 框架将相同 key I 的值聚合起来传递给 Reduce 函数</li>
<li>Reduce 函数接受中间 key I 和该 key 的值的集合，将这些值聚合起来组成一个更小的值的集合</li>
</ul>
<h3 id="1-2-数据结构"><a href="#1-2-数据结构" class="headerlink" title="1.2 数据结构"></a>1.2 数据结构</h3><ul>
<li>Map (k1, v1) -&gt; list(k2, v2)</li>
<li>Reduce (k2, list(v2)) -&gt; list(v2)</li>
</ul>
<h2 id="2-执行概览"><a href="#2-执行概览" class="headerlink" title="2 执行概览"></a>2 执行概览</h2><h3 id="2-1-整体流程"><a href="#2-1-整体流程" class="headerlink" title="2.1 整体流程"></a>2.1 整体流程</h3><p><img src="/2020/08/06/MapReduce笔记/image-20200812235617912.png" alt="image-20200812235617912"></p>
<ul>
<li>把输入文件分成 M 份，通常 16-64 MB 每一份</li>
<li>共有 M 个 map 任务和 R 个 reduce 任务</li>
<li>被分配了 map 任务的 worker 读分割文件中的内容，拿到 key-value 并传给 Map 函数，得到的中间 key-value 缓存在内存中</li>
<li>缓存的键值对写入本地内存中，被分割函数分为 R 个区域<ul>
<li>中间 key 被分割函数划分到 R 个 Reduce 任务中，如 hash(key) mod R</li>
</ul>
</li>
<li>worker 被分配给 reduce 任务后，读本地磁盘中的缓存数据。读取所有的数据后，按中间 key 排序，使相同 key 的对排在一起。如果缓存数据在内存中排序的总量过大，则需要额外的排序</li>
<li>将排序后的中间 key-value 集传给 Reduce 函数，其输出被合并为最终的输出文件（有时不需要合并，可以作为下一个 MapReduce 调用的输入）</li>
<li>当所有的 map 和 reduce 任务都完成时，master 唤醒用户程序</li>
</ul>
<h3 id="2-2-Master-的数据结构"><a href="#2-2-Master-的数据结构" class="headerlink" title="2.2 Master 的数据结构"></a>2.2 Master 的数据结构</h3><ul>
<li><p>对于每个 map 和 reduce 任务都存储了任务的状态（空闲、进行中、完成）和其 worker 机器的唯一标示</p>
</li>
<li><p>对于每个完成的 map 任务，master 存储了其生成的 R 个中间文件的位置和大小，不断从完成的任务获取并更新并发送给开始的 reduce 任务</p>
</li>
</ul>
<h3 id="2-3-容错"><a href="#2-3-容错" class="headerlink" title="2.3 容错"></a>2.3 容错</h3><h4 id="2-3-1-Worker-故障"><a href="#2-3-1-Worker-故障" class="headerlink" title="2.3.1 Worker 故障"></a>2.3.1 Worker 故障</h4><p>master 定时给每个 worker 发送心跳，如果一段时间没有收到某个任务的心跳或者任务失败就标记其为空闲，开始重新调度</p>
<p>已经完成的 map 任务如果再次被执行会导致失败因为其输出存储在本地磁盘；同理完成的 reduce 任务不需要被再次执行因为其输出存储在 gfs 中</p>
<p>如果一个 map 任务被 worker A 执行失败后又被 worker B 执行，所有执行 reduce 任务的 worker 都会被通知并且重新执行。还没开始从 worker A 读数据的 reduce 任务会从 worker B 读数据</p>
<h4 id="2-3-2-Master-故障"><a href="#2-3-2-Master-故障" class="headerlink" title="2.3.2 Master 故障"></a>2.3.2 Master 故障</h4><p>Master 会写入描述 master 数据结构的 checkpoints 来保证当其故障时其副本会从 checkpoints 的状态起起来</p>
<h4 id="2-3-3-考虑故障的语义"><a href="#2-3-3-考虑故障的语义" class="headerlink" title="2.3.3 考虑故障的语义"></a>2.3.3 考虑故障的语义</h4><p>当 map 任务完成时，worker 发送给 master 一条包括 R 个中间文件名的信息，若 master 已经从已完成的任务接受过完整的信息则忽略，反之将其记录在 master 的数据结构中</p>
<p>依赖底层文件系统的原子的重命名操作来保证最终文件系统只包含一次 reduce 任务的执行结果</p>
<h3 id="2-4-定位"><a href="#2-4-定位" class="headerlink" title="2.4 定位"></a>2.4 定位</h3><p>master 得到输入文件的位置信息，会尝试调度一个有输入数据的副本的机器去执行 map 任务；如果不成功的话会尝试调度临近输入数据副本的机器去执行（如与有副本数据的机器在同一个交换机）</p>
<h3 id="2-5-任务粒度"><a href="#2-5-任务粒度" class="headerlink" title="2.5 任务粒度"></a>2.5 任务粒度</h3><p>M 和 R 应该大于 worker 机器的数量才能保证动态的负载均衡和恢复速度</p>
<h3 id="2-6-候补任务"><a href="#2-6-候补任务" class="headerlink" title="2.6 候补任务"></a>2.6 候补任务</h3><p>当 MapReduce 操作接近完成时，master 会调度候补执行仍然在运行中的任务，原生或者候补执行完成任务都被标记为完成，可以提高效率。</p>
<h2 id="3-改进"><a href="#3-改进" class="headerlink" title="3 改进"></a>3 改进</h2><h3 id="3-1-分割函数"><a href="#3-1-分割函数" class="headerlink" title="3.1 分割函数"></a>3.1 分割函数</h3><p>默认分割函数使用哈希 hash(key) mod R</p>
<h3 id="3-2-顺序保证"><a href="#3-2-顺序保证" class="headerlink" title="3.2 顺序保证"></a>3.2 顺序保证</h3><p>框架保证提供给定分割函数的话，中间 key-value 对会以增序排列</p>
<h3 id="3-3-Combiner-函数"><a href="#3-3-Combiner-函数" class="headerlink" title="3.3 Combiner 函数"></a>3.3 Combiner 函数</h3><p>可选的 combiner 函数数据从网络发出之前会调用</p>
<p>Reduce 函数和 Combiner 函数的唯一区别在于 MapReduce 框架如何处理函数的输出：reduce 函数的输出写入最终输出文件，combiner 函数的输出写入即将传给 reduce 任务的中间文件</p>
<h3 id="3-4-输入和输出类型"><a href="#3-4-输入和输出类型" class="headerlink" title="3.4 输入和输出类型"></a>3.4 输入和输出类型</h3><p>输入类型只需实现 reader 接口，则不仅可以从文件读数据、也可以从数据库、内存等读数据</p>
<h3 id="3-5-副作用"><a href="#3-5-副作用" class="headerlink" title="3.5 副作用"></a>3.5 副作用</h3><p>生成辅助文件时，依赖 writer 来使得副作用原子和幂等，如写入中间文件，当它完全生成后再将其原子重命名</p>
<h3 id="3-6-跳过坏记录"><a href="#3-6-跳过坏记录" class="headerlink" title="3.6 跳过坏记录"></a>3.6 跳过坏记录</h3><p>有时可以接受忽略一些记录，框架提供一个模式当 MapReduce检测到一些记录造成确定的异常时跳过它们</p>
<p>每个 worker 安装一个可以捕捉段错误的信号 handler，当用户代码生成了一个信号时，handler 发送一个包含序列号的 last gasp UDP 包给 master，当 master 在特定的记录收到大于一个错误时，标记该记录应该被跳过</p>
<h3 id="3-7-本地执行"><a href="#3-7-本地执行" class="headerlink" title="3.7 本地执行"></a>3.7 本地执行</h3><p>框架提供 debug 模式能让 MapReduce 中的所有的工作都在本地机器执行</p>
<h3 id="3-8-状态信息"><a href="#3-8-状态信息" class="headerlink" title="3.8 状态信息"></a>3.8 状态信息</h3><p>提供一个状态 web 页面展示计算的进程</p>
<h3 id="3-9-Counter"><a href="#3-9-Counter" class="headerlink" title="3.9 Counter"></a>3.9 Counter</h3><p>框架提供一个 counter 功能来统计事件，类似打点功能，在检查 MapReduce 操作时 Counter 十分有效</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/20/SRE监控告警/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huangyt">
      <meta itemprop="description" content="Blogs of learning CS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/20/SRE监控告警/" class="post-title-link" itemprop="url">SRE监控告警</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-20 22:05:24" itemprop="dateCreated datePublished" datetime="2020-07-20T22:05:24+08:00">2020-07-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-14 11:53:57" itemprop="dateModified" datetime="2020-09-14T11:53:57+08:00">2020-09-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/运维/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h2><h3 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h3><ul>
<li><p>白盒监控：依靠系统内部的性能指标进行监控</p>
<p>完全依赖白盒监控意味着不知道最终用户看到的是什么样的</p>
</li>
<li><p>黑盒监控：测试外部用户可见的系统行为进行监控</p>
</li>
<li><p>dashboard 监控台页面</p>
</li>
</ul>
<h3 id="监控系统的目标"><a href="#监控系统的目标" class="headerlink" title="监控系统的目标"></a>监控系统的目标</h3><ul>
<li>什么东西出故障了</li>
<li>为什么出故障（故障出在哪里</li>
</ul>
<h3 id="4个黄金指标"><a href="#4个黄金指标" class="headerlink" title="4个黄金指标"></a>4个黄金指标</h3><ul>
<li><p>延迟</p>
</li>
<li><p>流量</p>
<p>QPS、网络 I/O 速率、并发会话数量…</p>
</li>
<li><p>错误</p>
<p>包括显式失败（500）和隐式失败（200中包含了错误内容）</p>
</li>
<li><p>饱和度</p>
<p>延迟增加是饱和度的前导条件</p>
</li>
</ul>
<h3 id="长尾问题"><a href="#长尾问题" class="headerlink" title="长尾问题"></a>长尾问题</h3><p>少部分请求占用大量时间导致平均数、中位数无法判断情况——将请求按延迟分组计数（制作直方图），将直方图的边界定义为指数型增长</p>
<h3 id="监控系统的原则"><a href="#监控系统的原则" class="headerlink" title="监控系统的原则"></a>监控系统的原则</h3><ul>
<li>最能反映真实故障的规则应该越简单越好</li>
<li>不常用的数据收集、告警配置应该定时删除</li>
<li>收集到但是没有传给监控台或告警规则的应该定时删除</li>
</ul>
<h3 id="故障排查"><a href="#故障排查" class="headerlink" title="故障排查"></a>故障排查</h3><p><img src="/2020/07/20/SRE监控告警/image-20200808151310629.png" alt="image-20200808151310629"></p>
<p>日志和监控图标是确定问题根源的两个工具</p>
<h4 id="测试和恢复"><a href="#测试和恢复" class="headerlink" title="测试和恢复"></a>测试和恢复</h4><ul>
<li>理想的测试应该具有互斥性</li>
<li>先测试最可能的情况：按照可能发生的顺序测试</li>
<li>测试可能产生有误导性的结果</li>
<li>测试可能有副作用</li>
<li>测试可能无法得出准确的结论</li>
</ul>
<h2 id="告警"><a href="#告警" class="headerlink" title="告警"></a>告警</h2><h3 id="告警粒度和频率"><a href="#告警粒度和频率" class="headerlink" title="告警粒度和频率"></a>告警粒度和频率</h3><p>紧急警报太频繁会让人怀疑其有效性甚至忽略</p>
<p>多个报警可以被合并为一个，聚合成一个单独的故障能够减少报警信息的总数 </p>
<h3 id="告警方式"><a href="#告警方式" class="headerlink" title="告警方式"></a>告警方式</h3><ul>
<li>工单</li>
<li>E-mail</li>
<li>紧急警报</li>
<li>…</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/19/Go语言/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huangyt">
      <meta itemprop="description" content="Blogs of learning CS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/19/Go语言/" class="post-title-link" itemprop="url">Go语言</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-19 21:47:08" itemprop="dateCreated datePublished" datetime="2020-07-19T21:47:08+08:00">2020-07-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-14 11:56:57" itemprop="dateModified" datetime="2020-09-14T11:56:57+08:00">2020-09-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程语言/" itemprop="url" rel="index"><span itemprop="name">编程语言</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Go语言"><a href="#Go语言" class="headerlink" title="Go语言"></a>Go语言</h1><h2 id="编程细节"><a href="#编程细节" class="headerlink" title="编程细节"></a>编程细节</h2><ul>
<li>type 相关的定义可以抽到 xxx/types 的目录下，好处是可以避免循环引用</li>
<li>client 尽量复用，防止开了很多个客户端没有关闭导致 goroutine 数量暴涨</li>
<li>json.rawMessage 适用于根据情况如 type 来解结构体的情况</li>
<li>结构体作为数据库 Model 时字段要大写，并且要与数据库中对应字段一致</li>
<li>方便单测的编程技巧 <a href="https://juejin.im/post/5ce93447e51d45775746b8b0" target="_blank" rel="noopener">https://juejin.im/post/5ce93447e51d45775746b8b0</a></li>
</ul>
<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><h3 id="go-lint"><a href="#go-lint" class="headerlink" title="go-lint"></a>go-lint</h3><h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><h3 id="基础数据结构"><a href="#基础数据结构" class="headerlink" title="基础数据结构"></a>基础数据结构</h3><h4 id="String"><a href="#String" class="headerlink" title="String"></a>String</h4><p>string是不可变的，不能更改，故两个副本共享string的内存是安全的，s[:n]的代价也很低</p>
<h3 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h3><p>UTF-8 通过第一个字节开头的1来标示需要用到多少个字节</p>
<p><img src="/2020/07/19/Go语言/image-20200722233914366.png" alt="image-20200722233914366"></p>
<p>Strings bytes strconv unicode 包提供处理字符串的函数</p>
<p>string 操作开销较大，可以使用 bytes.Buffer</p>
<h3 id="复杂类型"><a href="#复杂类型" class="headerlink" title="复杂类型"></a>复杂类型</h3><h4 id="Arrays"><a href="#Arrays" class="headerlink" title="Arrays"></a>Arrays</h4><p>数组相当于一个固定量而非指针，所以复制传值的开销过大，切片就是解决方案</p>
<h4 id="Slice"><a href="#Slice" class="headerlink" title="Slice"></a>Slice</h4><p><a href="https://halfrost.com/go_slice/" target="_blank" rel="noopener">https://halfrost.com/go_slice/</a></p>
<h4 id="Maps"><a href="#Maps" class="headerlink" title="Maps"></a>Maps</h4><p><img src="/2020/07/19/Go语言/image-20200724171706774.png" alt="image-20200724171706774"></p>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><h4 id="Panic-和-Recover"><a href="#Panic-和-Recover" class="headerlink" title="Panic 和 Recover"></a>Panic 和 Recover</h4><p>Panic 会依次（先进先出）调用本协程的 defer() 后退出程序</p>
<p>Recover 会捕捉处理 panic，可以处理本协程的 panic，保证程序不会挂掉</p>
<h4 id="函数引用"><a href="#函数引用" class="headerlink" title="函数引用"></a>函数引用</h4><p>函数参数为值的时候传值和传指针都可以，因为 go 会将指针转换为值</p>
<h3 id="Goroutines-和-Channels"><a href="#Goroutines-和-Channels" class="headerlink" title="Goroutines 和 Channels"></a>Goroutines 和 Channels</h3><p>异步（有缓冲区）的 Channel 用完要 close，不然会阻塞，形成死锁</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/20/高性能MySQL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huangyt">
      <meta itemprop="description" content="Blogs of learning CS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/20/高性能MySQL/" class="post-title-link" itemprop="url">高性能MySQL</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-04-20 21:26:19" itemprop="dateCreated datePublished" datetime="2019-04-20T21:26:19+08:00">2019-04-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-07-19 16:42:15" itemprop="dateModified" datetime="2020-07-19T16:42:15+08:00">2020-07-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="MySQL基础"><a href="#MySQL基础" class="headerlink" title="MySQL基础"></a>MySQL基础</h2><h3 id="并发控制"><a href="#并发控制" class="headerlink" title="并发控制"></a>并发控制</h3><h4 id="读写锁"><a href="#读写锁" class="headerlink" title="读写锁"></a>读写锁</h4><ul>
<li>共享锁（读锁）：相互不阻塞，多个客户可以同时读取一个资源</li>
<li>排他锁（写锁）：写锁会 阻塞其他的写锁和读锁</li>
</ul>
<h4 id="锁粒度"><a href="#锁粒度" class="headerlink" title="锁粒度"></a>锁粒度</h4><h5 id="表锁"><a href="#表锁" class="headerlink" title="表锁"></a>表锁</h5><p>最基本的锁策略，开销最小。</p>
<p>锁定整张表，用户对表进行写操作前要先获得写锁，会阻塞其他用户的所有读写操作</p>
<h5 id="行级锁"><a href="#行级锁" class="headerlink" title="行级锁"></a>行级锁</h5><p>可以最大程度地支持并发处理，但也是锁开销最大的</p>
<h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h3><h4 id="ACID"><a href="#ACID" class="headerlink" title="ACID"></a>ACID</h4><ul>
<li>原子性：一个事务为不可分割的最小单元，要不全部执行，要不全部回滚，不可只执行一部分</li>
<li>一致性：数据库总是从一个一致性的状态转到另一个一致性的状态</li>
<li>隔离性：一个事务的修改在最终提交前对其他事务是不可见的</li>
<li>持久性：一旦事务提交，其所作的修改就永久保存到数据库中</li>
</ul>
<h4 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h4><ul>
<li>未提交读（READ UNCOMMITTED）：即使没有提交，对其他事务也是可见的，存在脏读问题</li>
<li>提交读（READ COMMITTED）（不可重复读）：只能看见已经提交的事务所做的修改，同一事务中多次读取同样记录的结果可能是不同的</li>
<li>可重复读（REPEARABLE READ）：同一事务中多次读取同样记录的结果是相同的，存在幻读问题</li>
<li>可串行化（SERIALIZALE）：强制事务串行执行</li>
</ul>
<h2 id="数据库和数据类型优化"><a href="#数据库和数据类型优化" class="headerlink" title="数据库和数据类型优化"></a>数据库和数据类型优化</h2><h3 id="数据类型的优化"><a href="#数据类型的优化" class="headerlink" title="数据类型的优化"></a>数据类型的优化</h3><h4 id="数据类型选择原则"><a href="#数据类型选择原则" class="headerlink" title="数据类型选择原则"></a>数据类型选择原则</h4><ul>
<li>更小的通常更好</li>
<li>简单数据类型更好：整形比字符简单</li>
<li>尽量避免NULL：包含NULL得列更难优化，因为索引、索引统计和值比较都更复杂</li>
<li>时间：TIMESTAMP占的存储空间比DATATIME小得多</li>
</ul>
<h4 id="整数类型"><a href="#整数类型" class="headerlink" title="整数类型"></a>整数类型</h4><p>TINYINT、SMALLINT\MEDIUMINT、INT、BIGINT分别用8、16、32、64位存储空间，范围从-2^(N-1) 到 2^(N-1)，N为位数</p>
<p>如果有UNSIGNED，不允许负值，可以使正数上限提高一倍</p>
<p>指定宽度对于存储和计算没有意义，只是规定交互工具显示的位数</p>
<h4 id="实数"><a href="#实数" class="headerlink" title="实数"></a>实数</h4><p>FLOAT、DOUBLE使用浮点计算（近似计算）</p>
<p>DECIMAL存储更精确的小数，但运算比浮点运算慢。数字会打包到二进制字符串中，每4个字节存储9个数字，小数点本身占一个字节</p>
<p>数据量较大时可以用BIGINT代替DECIMAL，乘以相应的倍数</p>
<h4 id="字符串类型"><a href="#字符串类型" class="headerlink" title="字符串类型"></a>字符串类型</h4><h5 id="VACHAR"><a href="#VACHAR" class="headerlink" title="VACHAR"></a>VACHAR</h5><p>存储变长字符串，需要用1或2个额外字节记录长度</p>
<p>UPDATE时可能使行变得比原来更长，使得页内没有更多空间可以存储。可能会拆成不同片段或者分裂页来解决，视存储引擎而定</p>
<p>适合的情况：字符串的最大长度远大于平均长度；列的更新很少，碎片不是问题</p>
<h5 id="CHAR"><a href="#CHAR" class="headerlink" title="CHAR"></a>CHAR</h5><p>会自动删除所有末尾空格</p>
<p>定长，适合长度一定，经常变更的值</p>
<h5 id="BLOB和TEXT"><a href="#BLOB和TEXT" class="headerlink" title="BLOB和TEXT"></a>BLOB和TEXT</h5><p>太大时会使用外部存储区域来存储，在行内需要1-4个字节来存储指针</p>
<p>排序时只对最前面的max_sort_length字节做排序</p>
<h4 id="日期和时间"><a href="#日期和时间" class="headerlink" title="日期和时间"></a>日期和时间</h4><p>DATETIME能保存大范围的值，从1001年到9999年，精度为秒，YYYYMMDDHHMMSS，用8个字节的空间</p>
<p>TIMESTAMP的范围从1970年到2038年，只用4个字节的存储空间</p>
<h4 id="位数据类型"><a href="#位数据类型" class="headerlink" title="位数据类型"></a>位数据类型</h4><h5 id="BIT"><a href="#BIT" class="headerlink" title="BIT"></a>BIT</h5><p>在一个列中存储一个或多个true/false，BIT(N)代表几位，最大64</p>
<p>但因为存在取值之后需要转化的问题尽量少使用</p>
<h5 id="SET"><a href="#SET" class="headerlink" title="SET"></a>SET</h5><p>可以存储多个true/false，有FIND_IN_SET()等函数，但是改变列的定义的代价较高</p>
<h4 id="标识列的选择"><a href="#标识列的选择" class="headerlink" title="标识列的选择"></a>标识列的选择</h4><ul>
<li>整数类型：最好的选择，速度快，可以使用AUTO_INCREMENT</li>
<li>字符串类型：消耗空间，计算慢；随机生成的值可能分布在很大空间内，使INSERT和一些SELECT语句变得很慢</li>
</ul>
<h4 id="特殊类型数据"><a href="#特殊类型数据" class="headerlink" title="特殊类型数据"></a>特殊类型数据</h4><p>可使用无符号整数来存储IP地址，INET_ATON()和INET_NTOA()可以进行转换</p>
<h3 id="设计缺陷"><a href="#设计缺陷" class="headerlink" title="设计缺陷"></a>设计缺陷</h3><ul>
<li>过多的列：从编码过的列转换成行数据结构的操作代价高</li>
<li>过多的关联</li>
<li>过度使用枚举</li>
<li>变相的枚举：set(‘Y’, ’N‘) 应该用枚举代替，两种情况并不会同时出现</li>
<li>过多使用NULL：用表示为空的数值代替NULL</li>
</ul>
<h3 id="范式和反范式"><a href="#范式和反范式" class="headerlink" title="范式和反范式"></a>范式和反范式</h3><h4 id="范式"><a href="#范式" class="headerlink" title="范式"></a>范式</h4><p>优点</p>
<ul>
<li>更新操作比反范式快</li>
<li>很少或者没有重复数据</li>
<li>表通常较小，可以很好地放在内存中，操作更快</li>
<li>查询时很少需要DISTINCT和GROUP BY语句（因为重复数据少）</li>
</ul>
<p>缺点：通常需要关联</p>
<h4 id="反范式"><a href="#反范式" class="headerlink" title="反范式"></a>反范式</h4><p>优点：避免关联</p>
<p>数据比内存大的时候扫全表比关联快，因为避免了随机IO</p>
<p>能使用更有效的索引策略：查找付费用户最近的10条信息，可以用索引代替关联查询</p>
<h3 id="缓存表和汇总表"><a href="#缓存表和汇总表" class="headerlink" title="缓存表和汇总表"></a>缓存表和汇总表</h3><h5 id="缓存表"><a href="#缓存表" class="headerlink" title="缓存表"></a>缓存表</h5><p>可以简单的从数据库其他表获取但速度较慢的表</p>
<h5 id="汇总表"><a href="#汇总表" class="headerlink" title="汇总表"></a>汇总表</h5><p>使用GROUP BY语句聚合数据的表</p>
<p>如计算24小时内发送的消息数：以每小时汇总表为基础，把前23个小时的计数加起来，再    加上开始阶段和结束阶段的不完全小时的计数</p>
<h4 id="影子表"><a href="#影子表" class="headerlink" title="影子表"></a>影子表</h4><p>重建表时保证数据在操作时仍可以使用：完成建表操作后通过一个原子重命名操作切换影子表和原表</p>
<h4 id="计数器表"><a href="#计数器表" class="headerlink" title="计数器表"></a>计数器表</h4><p>若只有一行数据，会导致事务只能串行执行</p>
<p>将表增加100行数据，再选择随机的槽进行更新，获取结果时使用聚合查询</p>
<h2 id="高性能索引"><a href="#高性能索引" class="headerlink" title="高性能索引"></a>高性能索引</h2><h3 id="索引类型"><a href="#索引类型" class="headerlink" title="索引类型"></a>索引类型</h3><h4 id="B-树索引"><a href="#B-树索引" class="headerlink" title="B+树索引"></a>B+树索引</h4><h5 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h5><p><img src="/2019/04/20/高性能MySQL/1555750864587.png" alt="1555750864587"></p>
<p>B+树索引适用于全键值、键值范围和键前缀查找，键前缀查找只适用于最左前缀的查找</p>
<h5 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h5><ul>
<li>如果不是按照索引的最左列开始查找，则无法使用索引</li>
<li>不能跳过索引中的列</li>
<li>如果查询中有某个列的范围查询，则右边所有的列都无法使用索引优化查找</li>
</ul>
<h4 id="联合索引"><a href="#联合索引" class="headerlink" title="联合索引"></a>联合索引</h4><h5 id="数据结构-1"><a href="#数据结构-1" class="headerlink" title="数据结构"></a>数据结构</h5><p><img src="/2019/04/20/高性能MySQL/1555747263954.png" alt="1555747263954"></p>
<h4 id="哈希索引"><a href="#哈希索引" class="headerlink" title="哈希索引"></a>哈希索引</h4><p>只有精确匹配索引所有列的查询才有效</p>
<p>索引存储对应的哈希值和行指针，结构十分紧凑，查找速度很快；关联很多查找表时哈希索引很适合</p>
<p>限制：</p>
<ul>
<li>不能使用索引中的值来避免读取行（哈希值没有意义）</li>
<li>无法用于排序</li>
<li>不支持部分索引匹配查找：索引（A,B）无法用于查询A</li>
<li>只支持等值查询</li>
<li>出现哈希冲突时必须遍历链表中的行指针，逐行比较</li>
<li>冲突越多，索引维护操作的代价更高</li>
</ul>
<p>对于较长的字符串列，可以手动计算哈希来模拟哈希函数，但这么做时不要使用SHA1()和MD5()作为哈希函数，因为其计算结构是长字符串，设计目标为最大限度消除冲突</p>
<h4 id="空间数据索引（R树）"><a href="#空间数据索引（R树）" class="headerlink" title="空间数据索引（R树）"></a>空间数据索引（R树）</h4><p>无需前缀索引，会从所有维度来索引数据</p>
<h4 id="全文索引"><a href="#全文索引" class="headerlink" title="全文索引"></a>全文索引</h4><p>查找文本中的关键词，并非直接比较数据</p>
<h3 id="索引的优点"><a href="#索引的优点" class="headerlink" title="索引的优点"></a>索引的优点</h3><ul>
<li>减少服务器扫描的数据量</li>
<li>帮助服务器避免排序和临时表</li>
<li>可以将随机I/O变为顺序I/O</li>
</ul>
<p>表较小时，大部分情况下扫全表更高效</p>
<h3 id="高性能索引策略"><a href="#高性能索引策略" class="headerlink" title="高性能索引策略"></a>高性能索引策略</h3><h4 id="独立的列"><a href="#独立的列" class="headerlink" title="独立的列"></a>独立的列</h4><p>索引不能是表达式的一部分或函数的参数，必须将索引列单独放在比较符号的一侧</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> actor_id <span class="keyword">FROM</span> actor <span class="keyword">WHERE</span> actor_id + <span class="number">1</span> = <span class="number">5</span>;</span><br></pre></td></tr></table></figure>
<h4 id="前缀索引和索引选择性"><a href="#前缀索引和索引选择性" class="headerlink" title="前缀索引和索引选择性"></a>前缀索引和索引选择性</h4><p>对于较长的字符串列可以索引开始部分的字符，节约索引空间，提高索引效率，但是会降低选择性</p>
<p>对于BLOB、TEXT或很长的VARCHAR的列，必须使用前缀索引</p>
<p>要选择长度合适的前缀</p>
<p>缺点：MySQL无法用前缀索引做ORDER BY和GROUP BY，也无法用前缀索引做覆盖扫描</p>
<h4 id="多列索引"><a href="#多列索引" class="headerlink" title="多列索引"></a>多列索引</h4><ul>
<li>多个索引做相交操作时（AND），需要一个包含所有相关列的多列索引</li>
<li>多个索引做联合操作时（OR），需要消耗大量的资源，特别是当有些索引的选择性不高时</li>
</ul>
<h4 id="选择合适的索引列顺序"><a href="#选择合适的索引列顺序" class="headerlink" title="选择合适的索引列顺序"></a>选择合适的索引列顺序</h4><p>将选择性最高的列放在最前列，但是要结合实际情况分析</p>
<h4 id="聚簇索引"><a href="#聚簇索引" class="headerlink" title="聚簇索引"></a>聚簇索引</h4><p>当表有聚簇索引时，数据行放在索引的叶子页中，一个表只能有一个聚簇索引，其他索引的值为行的主键值</p>
<p><img src="/2019/04/20/高性能MySQL/1555749566153.png" alt="1555749566153"></p>
<p>优点：</p>
<ul>
<li>可以把相关数据保存在一起，只需要从磁盘读取少量数据页就能获取某个用户的全部邮件</li>
<li>数据访问更快，索引和数据保存在同一颗B+树中</li>
<li>覆盖索引扫描的查询可以直接用页节点中的主键值</li>
</ul>
<p>缺点：</p>
<ul>
<li>如果数据在内存中，访问的顺序不那么重要，就没什么优势了</li>
<li>插入速度严重依赖于插入顺序</li>
<li>更新聚簇索引列的代价很高</li>
<li>插入新行时可能面临页分裂的问题</li>
<li>可能导致扫全表变慢，尤其是行比较稀疏，或由于页分裂导致数据存储不连续时</li>
<li>二级索引比较大，其叶节点包含了引用行的主键列</li>
<li>二级索引需要两次索引查找</li>
</ul>
<h5 id="InnoDB和MyISAM的数据分布对比"><a href="#InnoDB和MyISAM的数据分布对比" class="headerlink" title="InnoDB和MyISAM的数据分布对比"></a>InnoDB和MyISAM的数据分布对比</h5><p>MyISAM按数据插入的顺序存储在磁盘上</p>
<p><img src="/2019/04/20/高性能MySQL/1555749613499.png" alt="1555749613499"></p>
<p>索引分布，主键和其他键相同</p>
<p><img src="/2019/04/20/高性能MySQL/1555749661031.png" alt="1555749661031"></p>
<p>InnoDB的数据分布：叶子节点存储所有数据</p>
<p><img src="/2019/04/20/高性能MySQL/1555749700200.png" alt="1555749700200"></p>
<p>InnoDB的二级索引分布</p>
<p><img src="/2019/04/20/高性能MySQL/1555749789800.png" alt="1555749789800"></p>
<p>MySIAM二级索引的叶子节点存储行指针，InnoDB存储主键值</p>
<h5 id="聚簇和非聚簇表对比"><a href="#聚簇和非聚簇表对比" class="headerlink" title="聚簇和非聚簇表对比"></a>聚簇和非聚簇表对比</h5><p><img src="/2019/04/20/高性能MySQL/1555749821295.png" alt="1555749821295"></p>
<h5 id="InnoDB的插入"><a href="#InnoDB的插入" class="headerlink" title="InnoDB的插入"></a>InnoDB的插入</h5><p>使用InnoDB时应尽可能地按主键顺序插入数据，并且尽可能使用单调增加的聚簇键的值来插入新行。最好避免随机的（不连续且分布范围大）聚簇索引，可以使用自增列作为主键保证按顺序写入。否则：</p>
<ul>
<li>写入的目标可能刷到磁盘上并从缓存移除，插入前不得不从磁盘找到并读取目标页到内存中，导致大量随机I/O</li>
<li>频繁页分裂，移动大量数据；页变得稀疏，被不规则填充，数据会有碎片</li>
</ul>
<p><img src="/2019/04/20/高性能MySQL/1555750197344.png" alt="1555750197344"></p>
<h4 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a>覆盖索引</h4><p>一个索引包含所有需要查询的字段的值</p>
<p>优点：</p>
<ul>
<li>索引条目通常少于数据航，减少数据访问量</li>
<li>所以按列值顺序存储，范围查询比从磁盘读取每一行I/O少得多</li>
<li>对于InnoDB的聚簇索引，若二级逐渐能覆盖查询，可以避免对主键索引的二次查询</li>
</ul>
<p>不是所有类型的索引都可以做覆盖索引：必须存储索引列的值，哈希、空间、全文索引不可以</p>
<h4 id="使用索引扫描来做排序"><a href="#使用索引扫描来做排序" class="headerlink" title="使用索引扫描来做排序"></a>使用索引扫描来做排序</h4><p>只有当索引的列顺序和ORDER BY子句的顺序和排列方向完全一致时才能用索引来对结果排序；若查询需要关联多张表，当ORDER BY子句引用的字段全部为第一个表时才能用索引进行排序</p>
<h4 id="冗余和重复索引"><a href="#冗余和重复索引" class="headerlink" title="冗余和重复索引"></a>冗余和重复索引</h4><p>（A，B）和（A）为冗余索引，因为（A，B）可以被当作（A）用</p>
<p>（A，B）和（B，A）不是冗余索引，因为B不是最左前缀</p>
<p>不同类型的索引也不是B+树索引的冗余索引</p>
<h4 id="索引和锁"><a href="#索引和锁" class="headerlink" title="索引和锁"></a>索引和锁</h4><p>InnoDB访问行时会对其加锁，索引能减少其访问的行数，从而减少锁的数量</p>
<p>InnoDB有可能无法再服务端过滤掉行后就释放锁，而必须等到适当的时候</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> actor_id <span class="keyword">FROM</span> actor <span class="keyword">WHERE</span> actor_id &lt; <span class="number">5</span> <span class="keyword">AND</span> actor_id &lt;&gt; <span class="number">1</span> FORUPDATE;</span><br></pre></td></tr></table></figure>
<p>此时锁住了第1-4行，即使第1行不在结果中</p>
<p>即使使用索引也可能锁住不需要的数据，不使用索引可能更糟糕：锁全表</p>
<h3 id="索引案例"><a href="#索引案例" class="headerlink" title="索引案例"></a>索引案例</h3><h4 id="技巧"><a href="#技巧" class="headerlink" title="技巧"></a>技巧</h4><ul>
<li>当某个查询不限制性别时，可以在查询条件中新增AND SEX IN(‘m’, ‘f’)来访MySQL选择该索引，匹配最左前缀</li>
<li>尽可能将范围查询（age）放在最后，以便优化器使用尽可能多的索引列</li>
<li>IN(a,b,c…)条件如果太多，优化器要做的组合会指数增长</li>
</ul>
<h4 id="优化排序"><a href="#优化排序" class="headerlink" title="优化排序"></a>优化排序</h4><p>通过覆盖索引查询返回需要的主键，再根据主键关联原表获得需要的行，减少MySQL扫描那些要丢弃的行数</p>
<p><img src="/2019/04/20/高性能MySQL/1555753418063.png" alt="1555753418063"></p>
<h4 id="索引和数据碎片"><a href="#索引和数据碎片" class="headerlink" title="索引和数据碎片"></a>索引和数据碎片</h4><p>数据碎片类型</p>
<ul>
<li>行碎片：数据行被存储在多个地方的多个片段中，即使只访问一行记录性能也会下降</li>
<li>行间碎片：逻辑上顺序的页或行，在磁盘上不是顺序存储的。影响全表扫描和基础索引扫描等</li>
<li>剩余空间碎片：数据页中有大量空余空间，导致服务器读取大量不需要的数据</li>
</ul>
<p>MyISAM表三种碎片化都可能发生；InnoDB不会出现短小的行碎片，会移动短小的行并重写到一个片段中</p>
<h4 id="三个原则"><a href="#三个原则" class="headerlink" title="三个原则"></a>三个原则</h4><ul>
<li>单行访问是很慢的</li>
<li>按顺序访问范围数据是很快的：<ul>
<li>顺序I/O不需要多次磁盘寻道，比随机I/O要快很多</li>
<li>如果要顺序读取数据，不需要额外的排序操作</li>
</ul>
</li>
<li>索引覆盖查询是很快的</li>
</ul>
<h2 id="查询性能优化"><a href="#查询性能优化" class="headerlink" title="查询性能优化"></a>查询性能优化</h2><h3 id="优化数据访问"><a href="#优化数据访问" class="headerlink" title="优化数据访问"></a>优化数据访问</h3><p>分析步骤：</p>
<ul>
<li>确认应用程序是否检索大量超过需要的数据：访问太多的行或访问太多的列</li>
<li>确认MySQL服务器是否分析大量超过需要的数据行</li>
</ul>
<h4 id="是否向数据库请求了不需要的数据"><a href="#是否向数据库请求了不需要的数据" class="headerlink" title="是否向数据库请求了不需要的数据"></a>是否向数据库请求了不需要的数据</h4><ul>
<li><p>查询不需要的记录：查询100条，返回10条；应该使用LIMIT</p>
</li>
<li><p>多表关联时返回全部列</p>
</li>
<li>总是取出全部列</li>
<li>重复查询相同数据</li>
</ul>
<h4 id="MySQL是否扫描额外的记录"><a href="#MySQL是否扫描额外的记录" class="headerlink" title="MySQL是否扫描额外的记录"></a>MySQL是否扫描额外的记录</h4><p>衡量指标：响应时间、扫描行数、返回的行数</p>
<p>若需扫描大量数据但返回少数行，可采取的优化方式：</p>
<ul>
<li>使用索引覆盖扫描，无需回表取对应行即可返回结果</li>
<li>改变库表结构，如使用单独的汇总表</li>
<li>重写复杂查询</li>
</ul>
<h3 id="重构查询的方式"><a href="#重构查询的方式" class="headerlink" title="重构查询的方式"></a>重构查询的方式</h3><h4 id="切分查询"><a href="#切分查询" class="headerlink" title="切分查询"></a>切分查询</h4><p>使用一个大语句一次性完成可能需要一次锁住多个数据，占用大量资源</p>
<h4 id="分解关联查询"><a href="#分解关联查询" class="headerlink" title="分解关联查询"></a>分解关联查询</h4><ul>
<li>缓存效率更高：若之前查询中行已经被缓存，之后的查询就可以减少一些查询行数</li>
<li>减少锁的竞争</li>
<li>减少冗余查询，在应用层做关联意味着对某条记录应用只需要查询一次，在数据层做可能要重复访问一部分数据</li>
</ul>
<h3 id="查询执行的基础"><a href="#查询执行的基础" class="headerlink" title="查询执行的基础"></a>查询执行的基础</h3><p><img src="/2019/04/20/高性能MySQL/1555755759168.png" alt="1555755759168"></p>
<h4 id="客户端-服务器通信协议"><a href="#客户端-服务器通信协议" class="headerlink" title="客户端/服务器通信协议"></a>客户端/服务器通信协议</h4><p>半双工：某个时刻要么是服务器向客户端发数据，要么是客户端向服务器发数据</p>
<p>无流量控制，必须完整接受结果后才响应</p>
<h4 id="查询缓存"><a href="#查询缓存" class="headerlink" title="查询缓存"></a>查询缓存</h4><p>对一个大小写敏感的哈希查找实现。即使查询和缓存只有一个字节不同，也不会匹配缓存结果</p>
<p>若命中查询缓存，返回查询结果之前会检查一次用户权限，没问题则跳过所有其他阶段，查询不会被解析不生成执行计划不被执行</p>
<h4 id="查询优化处理"><a href="#查询优化处理" class="headerlink" title="查询优化处理"></a>查询优化处理</h4><p>将一个SQL转换成一个执行计划，MySQL依照这个执行计划与存储引擎交互：解析SQL、预处理、优化SQL执行计划</p>
<h5 id="语法解析器和预处理"><a href="#语法解析器和预处理" class="headerlink" title="语法解析器和预处理"></a>语法解析器和预处理</h5><p>解析语句，生成解析树并检查是否合法</p>
<h5 id="查询优化器"><a href="#查询优化器" class="headerlink" title="查询优化器"></a>查询优化器</h5><p>预测执行计划的成本并选择最小的一个。评估成本时不考虑任何层面的缓存，假设读取任何数据都需要一次磁盘I/O</p>
<p>优化策略：</p>
<ul>
<li>静态优化：只需做一次</li>
<li>动态优化：每次执行时都重新评估</li>
</ul>
<p>优化类型：重新定义关联表的顺序、外连接转内连接、等价变换、优化计数函数、子查询优化、覆盖索引扫描、提前终止查询（使用LIMIT时）…</p>
<p>IN()中有大量取值时，会先排序再进行二分查找，比等价的OR查询速度快</p>
<h5 id="MySQL的关联查询"><a href="#MySQL的关联查询" class="headerlink" title="MySQL的关联查询"></a>MySQL的关联查询</h5><p>先将一系列单个查询的结果放入一个临时表中，再读出临时表数据来完成查询</p>
<p><img src="/2019/04/20/高性能MySQL/1555763597538.png" alt="1555763597538"></p>
<p>FROM中有子查询时，先执行子查询并将其结果放到一个临时表中</p>
<h4 id="执行计划"><a href="#执行计划" class="headerlink" title="执行计划"></a>执行计划</h4><p>生成一棵指令树，通过存储引擎执行完成这棵指令树并返回结果</p>
<p>总是左侧深度优先的树</p>
<h5 id="关联优化器"><a href="#关联优化器" class="headerlink" title="关联优化器"></a>关联优化器</h5><p>优化多表关联的顺序，会在所有的关联顺序中选择一个成本最小的来执行</p>
<p>执行计划的搜索空间过大时，使用贪婪的方法优化</p>
<h5 id="排序优化"><a href="#排序优化" class="headerlink" title="排序优化"></a>排序优化</h5><p>排序数据量小于缓冲区时，使用内存快速排序</p>
<p>内存不够排序时，将数据分块，对每个独立的块使用快速排序进行排序，合并并返回结果</p>
<h4 id="查询执行引擎，返回结果给客户端"><a href="#查询执行引擎，返回结果给客户端" class="headerlink" title="查询执行引擎，返回结果给客户端"></a>查询执行引擎，返回结果给客户端</h4><h3 id="MySQL查询优化器的局限性"><a href="#MySQL查询优化器的局限性" class="headerlink" title="MySQL查询优化器的局限性"></a>MySQL查询优化器的局限性</h3><h4 id="关联子查询"><a href="#关联子查询" class="headerlink" title="关联子查询"></a>关联子查询</h4><p>MySQL的关联子查询很糟糕，特别是WHERE条件中包含IN()的子查询语句</p>
<h4 id="松散索引扫描"><a href="#松散索引扫描" class="headerlink" title="松散索引扫描"></a>松散索引扫描</h4><p>目前MySQL还不支持</p>
<p>对于语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> tbl <span class="keyword">WHERE</span> b <span class="keyword">BETWEEN</span> <span class="number">2</span> <span class="keyword">AND</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>扫全表</p>
<p><img src="/2019/04/20/高性能MySQL/1555764941746.png" alt="1555764941746"></p>
<p>松散索引扫描</p>
<p><img src="/2019/04/20/高性能MySQL/1555764927204.png" alt="1555764927204"></p>
<h3 id="优化特定类型的查询"><a href="#优化特定类型的查询" class="headerlink" title="优化特定类型的查询"></a>优化特定类型的查询</h3><h4 id="COUNT"><a href="#COUNT" class="headerlink" title="COUNT()"></a>COUNT()</h4><p>统计列值：要求列值非空（不为NULL）</p>
<p>统计行数：COUNT(*)时，不会扩展成所有的列，而是直接统计行数</p>
<h4 id="优化LIMIT-分页"><a href="#优化LIMIT-分页" class="headerlink" title="优化LIMIT 分页"></a>优化LIMIT 分页</h4><p>如果偏移量很大时，可能需要查询大量的记录再返回很少量的记录，代价巨大</p>
<p>优化方法</p>
<ul>
<li>尽可能用索引覆盖扫描</li>
<li>将LIMIT转为已知位置的存储：WHERE position BETWEEN 50 AND 54 ORDER BY position</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/18/python笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huangyt">
      <meta itemprop="description" content="Blogs of learning CS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/18/python笔记/" class="post-title-link" itemprop="url">python笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-04-18 20:20:20" itemprop="dateCreated datePublished" datetime="2019-04-18T20:20:20+08:00">2019-04-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-07-19 16:42:15" itemprop="dateModified" datetime="2020-07-19T16:42:15+08:00">2020-07-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程语言/" itemprop="url" rel="index"><span itemprop="name">编程语言</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="可变对象和不可变对象"><a href="#可变对象和不可变对象" class="headerlink" title="可变对象和不可变对象"></a>可变对象和不可变对象</h3><p>python中所有东西都是一个对象</p>
<ul>
<li>不可变对象：int，string，float，tuple</li>
<li>可变对象   ：list，dictionary</li>
</ul>
<h4 id="不可变对象immutable"><a href="#不可变对象immutable" class="headerlink" title="不可变对象immutable"></a>不可变对象immutable</h4><p>python中的对象存放的是对象引用，所以尽管不可变对象本身不可变，但其对象引用是可变的</p>
<p><img src="/2019/04/18/python笔记/1555570792969.png" alt="1555570792969"></p>
<h4 id="可变对象mutable"><a href="#可变对象mutable" class="headerlink" title="可变对象mutable"></a>可变对象mutable</h4><p>可变对象的内容可以发生变化，但其引用不会改变</p>
<p><img src="/2019/04/18/python笔记/1555571056395.png" alt="1555571056395"></p>
<h4 id="地址问题"><a href="#地址问题" class="headerlink" title="地址问题"></a>地址问题</h4><p>id()返回一个对象的地址或者用is；==对比值</p>
<p>不可变对象的引用改变后，其地址发生变化；可变对象改变后其地址不变</p>
<h4 id="参数传递"><a href="#参数传递" class="headerlink" title="参数传递"></a>参数传递</h4><p>python中向函数传参都是引用传递（传地址）</p>
<p>当传的参数是不可变对象时，函数复制一份引用，所以无论怎么操作传入的参数都不会对函数外的变量造成影响；当传入的参数是可变对象时，函数内操作会改变函数外变量的内容</p>
<p>不要用可变对象作为参数的默认值</p>
<h3 id="迭代器和生成器"><a href="#迭代器和生成器" class="headerlink" title="迭代器和生成器"></a>迭代器和生成器</h3><p><img src="/2019/04/18/python笔记/1555573612285.png" alt="1555573612285"></p>
<h4 id="迭代"><a href="#迭代" class="headerlink" title="迭代"></a>迭代</h4><p>可迭代对象：实现了<strong>iter</strong>方法的对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> d.items()</span><br><span class="line"><span class="keyword">for</span> i, value <span class="keyword">in</span> enumerate([<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>])</span><br></pre></td></tr></table></figure>
<h4 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h4><p>优点：对延迟操作提供了支持，在需要的时候才产生结果，而不是立即产生结果，减少资源消耗；可读性强（认准yield即可知道返回的结果）</p>
<h5 id="生成器函数"><a href="#生成器函数" class="headerlink" title="生成器函数"></a>生成器函数</h5><p>每次调用next()执行，遇到yield语句返回，再次执行时从上次返回的yield语句处继续执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gensquatres</span><span class="params">(N)</span>:</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(N):</span><br><span class="line">        <span class="keyword">yield</span> i**<span class="number">2</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># gensquatres是一个生成器对象</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> gensquares(<span class="number">5</span>):</span><br><span class="line">    print(item)</span><br></pre></td></tr></table></figure>
<h5 id="生成式表达式"><a href="#生成式表达式" class="headerlink" title="生成式表达式"></a>生成式表达式</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">squares = (x**<span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">next(squares)</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> squares:</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>注意：生成器只能遍历一次</p>
<h4 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h4><p>迭代器：实现了迭代器协议的对象，可以用isinstance()判断</p>
<p>迭代器协议：对象需要提供next()方法和<strong>iter</strong>()方法返回迭代器类的实例，返回下一项或引起StopIteration异常，以终止迭代</p>
<h4 id="yield-from"><a href="#yield-from" class="headerlink" title="yield from"></a>yield from</h4><p>yield from后加上可迭代对象可以将其每个元素yield出来</p>
<h5 id="生成嵌套"><a href="#生成嵌套" class="headerlink" title="生成嵌套"></a>生成嵌套</h5><p>在yield from后面加上生成器</p>
<ul>
<li><p>调用方：调用委派生成器的客户端（调用方）代码</p>
</li>
<li><p>委托生成器：包含yield from表达式的生成器函数</p>
</li>
<li>子生成器：yield from后面加的生成器函数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 子生成器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">average_gen</span><span class="params">()</span>:</span></span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    average = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        new_num = <span class="keyword">yield</span> average</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        total += new_num</span><br><span class="line">        average = total/count</span><br><span class="line"></span><br><span class="line"><span class="comment"># 委托生成器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proxy_gen</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> average_gen()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用方</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    calc_average = proxy_gen()</span><br><span class="line">    next(calc_average)            <span class="comment"># 预激下生成器</span></span><br><span class="line">    print(calc_average.send(<span class="number">10</span>))  <span class="comment"># 打印：10.0</span></span><br><span class="line">    print(calc_average.send(<span class="number">20</span>))  <span class="comment"># 打印：15.0</span></span><br><span class="line">    print(calc_average.send(<span class="number">30</span>))  <span class="comment"># 打印：20.0</span></span><br></pre></td></tr></table></figure>
<p>委托生成器，在调用方与子生成器之间建立一个双向通道，可以简化代码，而且会自动处理异常</p>
<h3 id="函数式编程"><a href="#函数式编程" class="headerlink" title="函数式编程"></a>函数式编程</h3><h4 id="map-reduce"><a href="#map-reduce" class="headerlink" title="map-reduce"></a>map-reduce</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> reduce</span><br><span class="line">map(f, [x1, x2, x3, x4]) = [f(x1), f(x2), f(x3), f(x4)]</span><br><span class="line">reduce(f, [x1, x2, x3, x4]) = f(f(f(x1, x2), x3), x4)</span><br></pre></td></tr></table></figure>
<p>配合lambda函数可以进一步简化</p>
<h4 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h4><p>filter()函数返回的是一个Iterator，也就是一个惰性序列，所以要强迫filter()完成计算结果，需要用list()函数获得所有结果并返回list</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_odd</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> n % <span class="number">2</span> == <span class="number">1</span></span><br><span class="line"></span><br><span class="line">list(filter(is_odd, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">15</span>]))</span><br></pre></td></tr></table></figure>
<h4 id="sorted"><a href="#sorted" class="headerlink" title="sorted"></a>sorted</h4><h3 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h3><p>被用于有切面需求的场景，较为经典的有插入日志、性能测试、事务处理等。为已经存在的对象添加额外的功能，并重用代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(text)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(func)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kw)</span>:</span></span><br><span class="line">            print(<span class="string">'%s %s():'</span> % (text, func.__name__))</span><br><span class="line">            <span class="keyword">return</span> func(*args, **kw)</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    <span class="keyword">return</span> decorator</span><br><span class="line">...</span><br><span class="line"><span class="meta">@log('execute')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">now</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'2015-3-25'</span>)</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>now()</span><br><span class="line">execute now():</span><br><span class="line"><span class="number">2015</span><span class="number">-3</span><span class="number">-25</span></span><br></pre></td></tr></table></figure>
<p>另一个例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makebold</span><span class="params">(fn)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapped</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;b&gt;"</span> + fn(*args, **kwargs) + <span class="string">"&lt;/b&gt;"</span></span><br><span class="line">    <span class="keyword">return</span> wrapped</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makeitalic</span><span class="params">(fn)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapped</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;i&gt;"</span> + fn(*args, **kwargs) + <span class="string">"&lt;/i&gt;"</span></span><br><span class="line">    <span class="keyword">return</span> wrapped</span><br><span class="line"></span><br><span class="line"><span class="meta">@makebold</span></span><br><span class="line"><span class="meta">@makeitalic</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"hello world"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@makebold</span></span><br><span class="line"><span class="meta">@makeitalic</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">print</span> hello()        <span class="comment"># returns "&lt;b&gt;&lt;i&gt;hello world&lt;/i&gt;&lt;/b&gt;"</span></span><br></pre></td></tr></table></figure>
<h3 id="面向对象"><a href="#面向对象" class="headerlink" title="面向对象"></a>面向对象</h3><p>类中定义的函数只有一点不同，就是第一个参数永远是实例变量self，并且，调用时，不用传递该参数</p>
<h4 id="私有变量"><a href="#私有变量" class="headerlink" title="私有变量"></a>私有变量</h4><p>__开头的变量，原理为将该变量重命名为（真正的私有变量）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_classname__varname</span><br></pre></td></tr></table></figure>
<p>_开头是一种约定，为私有变量</p>
<h4 id="函数重载"><a href="#函数重载" class="headerlink" title="函数重载"></a>函数重载</h4><p>函数重载能解决的问题：</p>
<ul>
<li>可变参数类型：python 可以接受任何类型的参数，如果函数的功能相同，那么不同的参数类型在 python 中很可能是相同的代码，没有必要做成两个不同函数</li>
<li>可变参数个数：对那些缺少的参数设定为缺省参数即可解决问题。因为你假设函数功能相同，那么那些缺少的参数终归是需要用的</li>
</ul>
<p>故python中不需要函数重载</p>
<h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><p>实例可以任意绑定属性和方法。给实例绑定属性的方法是通过实例变量，或者通过self变量</p>
<p>类属性直接在class中定义属性</p>
<p>注意实例属性会屏蔽类属性，故类属性和实例属性不要重名</p>
<h4 id="slots"><a href="#slots" class="headerlink" title="__slots _"></a>__slots _</h4><p>_slots__变量用于限制该class实例能添加的属性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(object)</span>:</span></span><br><span class="line">    __slots__ = (<span class="string">'name'</span>, <span class="string">'age'</span>) <span class="comment"># 用tuple定义允许绑定的属性名称</span></span><br></pre></td></tr></table></figure>
<p>仅对当前类实例起作用，对继承的子类是不起作用的</p>
<h4 id="property"><a href="#property" class="headerlink" title="@property"></a>@property</h4><p>既能检查参数，又可以用类似属性这样简单的方式来访问类的变量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">score</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._score</span><br><span class="line"></span><br><span class="line"><span class="meta">    @score.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">score</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, int):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'score must be an integer!'</span>)</span><br><span class="line">        <span class="keyword">if</span> value &lt; <span class="number">0</span> <span class="keyword">or</span> value &gt; <span class="number">100</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'score must between 0 ~ 100!'</span>)</span><br><span class="line">        self._score = value</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = Student()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.score = <span class="number">60</span> <span class="comment"># OK，实际转化为s.set_score(60)</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.score <span class="comment"># OK，实际转化为s.get_score()</span></span><br><span class="line"><span class="number">60</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.score = <span class="number">9999</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  ...</span><br><span class="line">ValueError: score must between <span class="number">0</span> ~ <span class="number">100</span>!</span><br></pre></td></tr></table></figure>
<h4 id="静态方法、实例方法、类方法"><a href="#静态方法、实例方法、类方法" class="headerlink" title="静态方法、实例方法、类方法"></a>静态方法、实例方法、类方法</h4><table>
<thead>
<tr>
<th>\</th>
<th>实例方法</th>
<th>类方法</th>
<th>静态方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>a = A()</td>
<td>a.foo(x)</td>
<td>a.class_foo(x)</td>
<td>a.static_foo(x)</td>
</tr>
<tr>
<td>A</td>
<td>不可用</td>
<td>A.class_foo(x)</td>
<td>A.static_foo(x)</td>
</tr>
</tbody>
</table>
<h4 id="init-和new-方法"><a href="#init-和new-方法" class="headerlink" title="init()和new()方法"></a><strong>init</strong>()和<strong>new</strong>()方法</h4><p>__new()方法在init()方法之前执行</p>
<p>真正创建实例是new方法，init__方法做的事情是在对象创建好之后初始化变量</p>
<p>new方法返回一个创建的实例，init方法不返回</p>
<h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><p>捕获错误时也会捕获其子类</p>
<h3 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h3><p>class和json的转化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">json.dumps(item, default=<span class="keyword">lambda</span> obj: obj.__dict__)</span><br><span class="line">json.loads(json_str, object_hook=dict2student)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dict2student</span><span class="params">(d)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> Student(d[<span class="string">'name'</span>], d[<span class="string">'age'</span>], d[<span class="string">'score'</span>])</span><br></pre></td></tr></table></figure>
<h3 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h3><p>python对协程的支持是通过generator实现的</p>
<p>特点</p>
<ul>
<li><p>在单线程里实现任务的切换的</p>
</li>
<li><p>利用同步的方式去实现异步</p>
</li>
<li><p>不再需要锁，提高了并发性能</p>
</li>
</ul>
<p>生产者消费者：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">()</span>:</span></span><br><span class="line">    r = <span class="string">''</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        n = <span class="keyword">yield</span> r</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> n:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        print(<span class="string">'[CONSUMER] Consuming %s...'</span> % n)</span><br><span class="line">        r = <span class="string">'200 OK'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">produce</span><span class="params">(c)</span>:</span></span><br><span class="line">    c.send(<span class="literal">None</span>)</span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> n &lt; <span class="number">5</span>:</span><br><span class="line">        n = n + <span class="number">1</span></span><br><span class="line">        print(<span class="string">'[PRODUCER] Producing %s...'</span> % n)</span><br><span class="line">        r = c.send(n)</span><br><span class="line">        print(<span class="string">'[PRODUCER] Consumer return: %s'</span> % r)</span><br><span class="line">    c.close()</span><br><span class="line"></span><br><span class="line">c = consumer()</span><br><span class="line">produce(c)</span><br></pre></td></tr></table></figure>
<p>注意 send(n)为将参数传给yield</p>
<h3 id="垃圾回收机制"><a href="#垃圾回收机制" class="headerlink" title="垃圾回收机制"></a>垃圾回收机制</h3><p>Python GC主要使用引用计数（reference counting）来跟踪和回收垃圾。在引用计数的基础上，通过“标记-清除”（mark and sweep）解决容器对象可能产生的循环引用问题，通过“分代回收”（generation collection）以空间换时间的方法提高垃圾回收效率</p>
<h4 id="引用计数"><a href="#引用计数" class="headerlink" title="引用计数"></a>引用计数</h4><p>PyObject是每个对象必有的内容，其中ob_refcnt就是做为引用计数。当一个对象有新的引用时，它的ob_refcnt就会增加，当引用它的对象被删除，它的ob_refcnt就会减少.引用计数为0时，该对象生命就结束了。</p>
<p>优点:</p>
<ul>
<li>简单</li>
<li>实时性</li>
</ul>
<p>缺点:</p>
<ul>
<li>维护引用计数消耗资源</li>
<li>循环引用</li>
</ul>
<h4 id="标记-清除机制"><a href="#标记-清除机制" class="headerlink" title="标记-清除机制"></a>标记-清除机制</h4><p>基本思路是先按需分配，等到没有空闲内存的时候从寄存器和程序栈上的引用出发，遍历以对象为节点、以引用为边构成的图，把所有可以访问到的对象打上标记，然后清扫一遍内存空间，把所有没标记的对象释放</p>
<h4 id="分代技术"><a href="#分代技术" class="headerlink" title="分代技术"></a>分代技术</h4><p>将系统中的所有内存块根据其存活时间划分为不同的集合，每个集合就成为一个“代”，垃圾收集频率随着“代”的存活时间的增大而减小，存活时间通常利用经过几次垃圾回收来度量</p>
<h3 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h3><h4 id="new方法"><a href="#new方法" class="headerlink" title="new方法"></a>new方法</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Singleton</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, *args, **kw)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(cls, <span class="string">'_instance'</span>):</span><br><span class="line">            orig = super(Singleton, cls)</span><br><span class="line">            cls._instance = orig.__new__(cls, *args, **kw)</span><br><span class="line">        <span class="keyword">return</span> cls._instance</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span><span class="params">(Singleton)</span>:</span></span><br><span class="line">    a = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h4 id="装饰器版本"><a href="#装饰器版本" class="headerlink" title="装饰器版本"></a>装饰器版本</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">singleton</span><span class="params">(cls, *args, **kw)</span>:</span></span><br><span class="line">    instances = &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getinstance</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">if</span> cls <span class="keyword">not</span> <span class="keyword">in</span> instances:</span><br><span class="line">            instances[cls] = cls(*args, **kw)</span><br><span class="line">        <span class="keyword">return</span> instances[cls]</span><br><span class="line">    <span class="keyword">return</span> getinstance</span><br><span class="line"></span><br><span class="line"><span class="meta">@singleton</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>:</span></span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<h3 id="GIL线程全局锁"><a href="#GIL线程全局锁" class="headerlink" title="GIL线程全局锁"></a>GIL线程全局锁</h3><p>线程全局锁(Global Interpreter Lock),即Python为了保证线程安全而采取的独立线程运行的限制,就是一个核只能在同一时间运行一个线程.</p>
<p>解决办法就是多进程和下面的协程(协程也只是单CPU,但是能减小切换代价提升性能)</p>
<h3 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h3><ul>
<li>在一个外函数中定义了一个内函数</li>
<li>内函数里运用了外函数的临时变量</li>
<li>外函数的返回值是内函数的引用</li>
</ul>
<p>其中的临时变量只能被读取不能更改，若要等该要引入nonlocal语句</p>
<p>作用：类似装饰器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_sing</span><span class="params">(animal)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">make_voice</span><span class="params">(voice)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;&#125; sings &#123;&#125;"</span>.format(animal, voice)</span><br><span class="line">    <span class="keyword">return</span> make_voice</span><br><span class="line">  </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dog = make_sing(<span class="string">"dog"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dog(<span class="string">"wong"</span>)</span><br><span class="line"><span class="string">'dog sings wong'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cow = make_sing(<span class="string">"cow"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cow(<span class="string">"mow"</span>)</span><br><span class="line"><span class="string">'cow sings mow'</span></span><br></pre></td></tr></table></figure>
<h3 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h3><h4 id="连续赋值"><a href="#连续赋值" class="headerlink" title="连续赋值"></a>连续赋值</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a, b = b, a + b</span><br></pre></td></tr></table></figure>
<p>相当于</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t = (b, a + b) <span class="comment"># t是一个tuple</span></span><br><span class="line">a = t[<span class="number">0</span>]</span><br><span class="line">b = t[<span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<h4 id="args-amp-kwargs"><a href="#args-amp-kwargs" class="headerlink" title="*args &amp; **kwargs"></a>*args &amp; **kwargs</h4><ul>
<li>*args：可以传递任意数量的参数，index-value</li>
<li>**kwargs：可以使用没有事先定义的参数名，name-value</li>
</ul>
<h4 id="拷贝"><a href="#拷贝" class="headerlink" title="拷贝"></a>拷贝</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> copy</span><br><span class="line">a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, [<span class="string">'a'</span>, <span class="string">'b'</span>]]  <span class="comment">#原始对象</span></span><br><span class="line"></span><br><span class="line">b = a  <span class="comment">#赋值，传对象的引用</span></span><br><span class="line">c = copy.copy(a)  <span class="comment">#对象拷贝，浅拷贝</span></span><br><span class="line">d = copy.deepcopy(a)  <span class="comment">#对象拷贝，深拷贝</span></span><br><span class="line"></span><br><span class="line">a.append(<span class="number">5</span>)  <span class="comment">#修改对象a</span></span><br><span class="line">a[<span class="number">4</span>].append(<span class="string">'c'</span>)  <span class="comment">#修改对象a中的['a', 'b']数组对象</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">'a = '</span>, a</span><br><span class="line"><span class="keyword">print</span> <span class="string">'b = '</span>, b</span><br><span class="line"><span class="keyword">print</span> <span class="string">'c = '</span>, c</span><br><span class="line"><span class="keyword">print</span> <span class="string">'d = '</span>, d</span><br><span class="line"></span><br><span class="line">输出结果：</span><br><span class="line">a =  [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>], <span class="number">5</span>]</span><br><span class="line">b =  [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>], <span class="number">5</span>]</span><br><span class="line">c =  [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]]</span><br><span class="line">d =  [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, [<span class="string">'a'</span>, <span class="string">'b'</span>]]</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/18/HTTP详解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huangyt">
      <meta itemprop="description" content="Blogs of learning CS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/18/HTTP详解/" class="post-title-link" itemprop="url">HTTP详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-04-18 13:30:22" itemprop="dateCreated datePublished" datetime="2019-04-18T13:30:22+08:00">2019-04-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-07-19 16:42:15" itemprop="dateModified" datetime="2020-07-19T16:42:15+08:00">2020-07-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/计算机网络/" itemprop="url" rel="index"><span itemprop="name">计算机网络</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文为《图解http》的笔记，主要补充http相关的计算机网络知识</p>
<h2 id="HTTP基础"><a href="#HTTP基础" class="headerlink" title="HTTP基础"></a>HTTP基础</h2><h3 id="URI"><a href="#URI" class="headerlink" title="URI"></a>URI</h3><p>某个协议方案表示的资源定位标识符。协议方案指访问资源所用的协议类型名称。</p>
<p><img src="/2019/04/18/HTTP详解/1555410041635.png" alt="1555410041635"></p>
<p>请求URI可以为绝对URI，也可以为相对URI并且在首部字段Host中写明网络域名或IP地址</p>
<h3 id="报文"><a href="#报文" class="headerlink" title="报文"></a>报文</h3><p>报文=报文首部 + 报文主体，由一个空行（CR+LF）划分</p>
<h4 id="报文VS实体"><a href="#报文VS实体" class="headerlink" title="报文VS实体"></a>报文VS实体</h4><ul>
<li>报文：http通信的基本单位，由8位字节流组成</li>
<li>实体：作为请求或响应的有效载荷数据被传输，由实体首部和实体主体组成</li>
<li>通常，报文主体等于实体主体，只有当传输中进行编码操作时，实体主体的内容才会发生变化，区别于报文主体</li>
</ul>
<h4 id="请求报文"><a href="#请求报文" class="headerlink" title="请求报文"></a>请求报文</h4><p><img src="/2019/04/18/HTTP详解/1555410100190.png" alt="1555410100190"></p>
<h4 id="响应报文"><a href="#响应报文" class="headerlink" title="响应报文"></a>响应报文</h4><p><img src="/2019/04/18/HTTP详解/1555410136328.png" alt="1555410136328"></p>
<h3 id="HTTP方法"><a href="#HTTP方法" class="headerlink" title="HTTP方法"></a>HTTP方法</h3><p>GET、POST</p>
<h4 id="PUT"><a href="#PUT" class="headerlink" title="PUT"></a>PUT</h4><p>上传文件，在报文主体中包含文件内容；但不带验证机制，存在安全性问题，一般不使用</p>
<h4 id="HEAD"><a href="#HEAD" class="headerlink" title="HEAD"></a>HEAD</h4><p>和GET一样，但是不返回报文主体部分，用于确认URI的有效性和资源更新的日期时间等</p>
<h4 id="DELETE"><a href="#DELETE" class="headerlink" title="DELETE"></a>DELETE</h4><p>与PUT相反，也不带验证机制</p>
<p>PUT和DELETE配合Web的验证机制，遵守REST标准时可以开放使用</p>
<h4 id="OPTIONS"><a href="#OPTIONS" class="headerlink" title="OPTIONS"></a>OPTIONS</h4><p>查询URI的资源支持的方法</p>
<h4 id="TRACE"><a href="#TRACE" class="headerlink" title="TRACE"></a>TRACE</h4><p>追踪路径，在Max-Forwards首部填入数值（跳数），最后接收到请求的服务器返回200OK</p>
<p>不常用，而且容易引发XST（跨站追踪）攻击</p>
<h4 id="CONNECT"><a href="#CONNECT" class="headerlink" title="CONNECT"></a>CONNECT</h4><p>要求与代理服务器通信时建立隧道，用隧道协议进行TCP通信，主要用SSL和TLS进行加密</p>
<p><img src="/2019/04/18/HTTP详解/1555496635805.png" alt="1555496635805"></p>
<h3 id="分块传输编码"><a href="#分块传输编码" class="headerlink" title="分块传输编码"></a>分块传输编码</h3><p>将实体主体分为多个部分，每一块用16进制来标记块的大小，实体主体的最后一块会使用“0（CR+LF）”来标记</p>
<h3 id="获取部分内容的范围请求"><a href="#获取部分内容的范围请求" class="headerlink" title="获取部分内容的范围请求"></a>获取部分内容的范围请求</h3><p>用首部字段Range来指定资源的byte范围</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Range：bytes=5001-10000</span><br></pre></td></tr></table></figure>
<p>对于范围请求会返回状态码为206Partial Content的响应报文；若服务器无法响应范围请求，会返回状态码200OK的完整实体内容</p>
<h2 id="HTTP状态码"><a href="#HTTP状态码" class="headerlink" title="HTTP状态码"></a>HTTP状态码</h2><table>
<thead>
<tr>
<th></th>
<th>类别</th>
<th>原因短语</th>
</tr>
</thead>
<tbody>
<tr>
<td>1xx</td>
<td>Informational</td>
<td>请求正在处理</td>
</tr>
<tr>
<td>2xx</td>
<td>Success</td>
<td>请求处理完毕</td>
</tr>
<tr>
<td>3xx</td>
<td>Redirection</td>
<td>需要附加操作来完成请求</td>
</tr>
<tr>
<td>4xx</td>
<td>Client Error</td>
<td>服务器无法处理请求</td>
</tr>
<tr>
<td>5xx</td>
<td>Server Error</td>
<td>服务器处理请求出错</td>
</tr>
</tbody>
</table>
<h3 id="2XX-成功"><a href="#2XX-成功" class="headerlink" title="2XX 成功"></a>2XX 成功</h3><h4 id="200-OK"><a href="#200-OK" class="headerlink" title="200 OK"></a>200 OK</h4><p>正常处理</p>
<h4 id="204-No-Content"><a href="#204-No-Content" class="headerlink" title="204 No Content"></a>204 No Content</h4><p>成功处理，但返回的相应报文中不包含实体的主体部分。一般在只需从客户端往服务器发送信息，而对客户端不需要发送新信息内容的情况下使用。</p>
<p>如在PUT请求中进行资源更新，但是不需要改变当前展示给用户的页面。</p>
<h4 id="206-Partial-Content"><a href="#206-Partial-Content" class="headerlink" title="206 Partial Content"></a>206 Partial Content</h4><p>进行了范围请求，服务器成功执行，响应报文中用Content-Range指定范围的实体内容</p>
<h3 id="3XX-重定向"><a href="#3XX-重定向" class="headerlink" title="3XX 重定向"></a>3XX 重定向</h3><h4 id="301-Moved-Permanently"><a href="#301-Moved-Permanently" class="headerlink" title="301 Moved Permanently"></a>301 Moved Permanently</h4><p>永久重定向。浏览器会跳转到重定向的URI并记录下来，以后每次访问次URI都会进行跳转，而不会对该URI发起请求</p>
<h4 id="302-Found"><a href="#302-Found" class="headerlink" title="302 Found"></a>302 Found</h4><p>临时重定向。跳转到重定向的URI，但不会记录在浏览器中</p>
<h4 id="303-See-Other"><a href="#303-See-Other" class="headerlink" title="303 See Other"></a>303 See Other</h4><p>类似302，通常作为 PUT或 POST操作的返回结果，区别在于表示客户端应该使用GET方法获取资源</p>
<p>浏览器得到301302303时，都会把POST改为GET，删除请求报文中的主体，自动重发</p>
<h4 id="304-Not-Modified"><a href="#304-Not-Modified" class="headerlink" title="304 Not Modified"></a>304 Not Modified</h4><p>未满足请求报文中的条件，不包含响应的主体部分</p>
<h4 id="307-Temporary-Redirect"><a href="#307-Temporary-Redirect" class="headerlink" title="307 Temporary Redirect"></a>307 Temporary Redirect</h4><p>与302相同，但是不会从POST变为GET</p>
<p>注意POST请求的重定向要使用307</p>
<h3 id="4XX-客户端错误"><a href="#4XX-客户端错误" class="headerlink" title="4XX 客户端错误"></a>4XX 客户端错误</h3><h4 id="400-Bad-Request"><a href="#400-Bad-Request" class="headerlink" title="400 Bad Request"></a>400 Bad Request</h4><p>报文中存在语法错误</p>
<h4 id="401-Unauthorized"><a href="#401-Unauthorized" class="headerlink" title="401 Unauthorized"></a>401 Unauthorized</h4><p>第一次发送表示需要有用过Http认证的认证信息；第二次发送表示用户认证失败</p>
<h4 id="403-Forbidden"><a href="#403-Forbidden" class="headerlink" title="403 Forbidden"></a>403 Forbidden</h4><p>请求资源的访问被服务器拒绝</p>
<h4 id="404-Not-Found"><a href="#404-Not-Found" class="headerlink" title="404 Not Found"></a>404 Not Found</h4><h3 id="5XX-服务器错误"><a href="#5XX-服务器错误" class="headerlink" title="5XX 服务器错误"></a>5XX 服务器错误</h3><h4 id="500-Internal-Server-Error"><a href="#500-Internal-Server-Error" class="headerlink" title="500 Internal Server Error"></a>500 Internal Server Error</h4><p>服务端在执行请求时发生错误</p>
<h4 id="502-Bad-Gateway"><a href="#502-Bad-Gateway" class="headerlink" title="502 Bad Gateway"></a>502 Bad Gateway</h4><p>上游服务器故障</p>
<h4 id="504-Gateway-Timeout"><a href="#504-Gateway-Timeout" class="headerlink" title="504 Gateway Timeout"></a>504 Gateway Timeout</h4><p>扮演网关或者代理的服务器无法在规定的时间内获得想要的响应，上游服务执行超时（超过代理网关的等待时间）</p>
<h3 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h3><p><img src="/2019/04/18/HTTP详解/1555500154422.png" alt="1555500154422"></p>
<h4 id="永久重定向之间的区别"><a href="#永久重定向之间的区别" class="headerlink" title="永久重定向之间的区别"></a>永久重定向之间的区别</h4><p><img src="/2019/04/18/HTTP详解/1555500178747.png" alt="1555500178747"></p>
<h4 id="临时重定向的区别"><a href="#临时重定向的区别" class="headerlink" title="临时重定向的区别"></a>临时重定向的区别</h4><p><img src="/2019/04/18/HTTP详解/1555500199054.png" alt="1555500199054"></p>
<h2 id="Web服务器"><a href="#Web服务器" class="headerlink" title="Web服务器"></a>Web服务器</h2><h3 id="数据转发"><a href="#数据转发" class="headerlink" title="数据转发"></a>数据转发</h3><h4 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h4><p>服务器和客户端的中间人</p>
<p>代理不改变URI，每次通过代理服务器转发请求或响应时，会追加写入Via首部信息</p>
<p><img src="/2019/04/18/HTTP详解/1555499743903.png" alt="1555499743903"></p>
<p>优点：使用缓存减少流量；实现特定URI访问控制、获取访问日志..</p>
<ul>
<li>缓存代理：将资源副本保存在服务器上，代理再次收到相同请求时可以不获取资源，直接将缓存的资源作为响应返回</li>
<li>透明代理：不对报文做任何加工</li>
</ul>
<h4 id="网关"><a href="#网关" class="headerlink" title="网关"></a>网关</h4><p>转发其他服务器通信数据的服务器，类似代理但可以提供非HTTP服务</p>
<p>可以提高通信安全性，因为可以在客户端和网关之间的通信线路上加密确保安全</p>
<h4 id="隧道"><a href="#隧道" class="headerlink" title="隧道"></a>隧道</h4><p>在客户端和服务器间中转，并保持双方通信连接。目的是确保客户端和服务器进行安全的通信。隧道不会解析HTTP请求，保持原样</p>
<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p>大致可归为两类：私有与共享缓存。共享缓存存储的响应能够被多个用户使用。私有缓存只能用于单独用户。包括浏览器与代理缓存，除此之外还有网关缓存、CDN、反向代理缓存和负载均衡器等部署在服务器上</p>
<p><img src="/2019/04/18/HTTP详解/1555500564455.png" alt="1555500564455"></p>
<p><img src="/2019/04/18/HTTP详解/1555500598866.png" alt="1555500598866"></p>
<p>若不超过缓存的有效期限则不请求服务器，直接返回</p>
<h4 id="客户端的缓存"><a href="#客户端的缓存" class="headerlink" title="客户端的缓存"></a>客户端的缓存</h4><p>缓存在浏览器中，称为临时网络文件</p>
<h4 id="缓存验证"><a href="#缓存验证" class="headerlink" title="缓存验证"></a>缓存验证</h4><h5 id="强校验器"><a href="#强校验器" class="headerlink" title="强校验器"></a>强校验器</h5><p>ETag响应头是一个对用户代理不透明的值。对于像浏览器这样的HTTP UA，不知道ETag代表什么，不能预测它的值是多少。如果资源请求的响应头里含有ETag, 客户端可以在后续的请求的头中带上 If-None-Match头来验证缓存</p>
<p>用首部If-Match来比较ETag</p>
<h5 id="弱校验器"><a href="#弱校验器" class="headerlink" title="弱校验器"></a>弱校验器</h5><p>Last-Modified响应头可以作为一种弱校验器。说它弱是因为它只能精确到一秒。如果响应头里含有这个信息，客户端可以在后续的请求中带上 If-Modified-Since来验证缓存</p>
<h4 id="带Vary头的响应"><a href="#带Vary头的响应" class="headerlink" title="带Vary头的响应"></a>带Vary头的响应</h4><p>决定了对于后续的请求头，如何判断是请求一个新的资源还是使用缓存的文件</p>
<p>当缓存服务器收到一个请求，只有当前的请求和原始（缓存）的请求头跟缓存的响应头里的Vary都匹配，才能使用缓存的响应</p>
<p><img src="/2019/04/18/HTTP详解/1555501195373.png" alt="1555501195373"></p>
<h2 id="HTTP首部"><a href="#HTTP首部" class="headerlink" title="HTTP首部"></a>HTTP首部</h2><h4 id="End2End-VS-HopbyHop"><a href="#End2End-VS-HopbyHop" class="headerlink" title="End2End VS HopbyHop"></a>End2End VS HopbyHop</h4><ul>
<li>End2End会转发给最终目标</li>
<li>HopbyHop只对单次转发有效</li>
<li>Http/1.1之后如果要使用HopbyHop首部，需提供Connection首部字段</li>
</ul>
<h3 id="通用首部"><a href="#通用首部" class="headerlink" title="通用首部"></a>通用首部</h3><h4 id="Cache-Control"><a href="#Cache-Control" class="headerlink" title="Cache-Control"></a>Cache-Control</h4><p>指定缓存工作机制（是否、最大Age值…）</p>
<p>请求指令：no-cache、no-store、max-age=100….</p>
<p>响应指令：public、no-cache、no-transform…</p>
<p><img src="/2019/04/18/HTTP详解/1555501712193.png" alt="1555501712193"></p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Cache-Control" target="_blank" rel="noopener">Cache-Control详细指令的含义</a></p>
<h4 id="Connection"><a href="#Connection" class="headerlink" title="Connection"></a>Connection</h4><p>作用：控制不再转发给代理的首部字段、管理持久连接</p>
<p>Connection：不再转发的首部字段名</p>
<p>服务器端想明确断开连接时，Connection：Close</p>
<h4 id="Date"><a href="#Date" class="headerlink" title="Date"></a>Date</h4><p>表明创建HTTP报文的日期和时间</p>
<h4 id="Pragama"><a href="#Pragama" class="headerlink" title="Pragama"></a>Pragama</h4><p>仅作为与HTTP/1.0的向后兼容而定义</p>
<h4 id="Trailer"><a href="#Trailer" class="headerlink" title="Trailer"></a>Trailer</h4><p>实现说明在报文主体后记录了哪些首部字段</p>
<h4 id="Transfer-Encoding"><a href="#Transfer-Encoding" class="headerlink" title="Transfer-Encoding"></a>Transfer-Encoding</h4><p>规定传输报文主体时采用的编码方式，HTTP/1.1的传输编码方式仅对分块传输编码有效</p>
<h4 id="Upgrade"><a href="#Upgrade" class="headerlink" title="Upgrade"></a>Upgrade</h4><p>检测HTTP协议及其他协议是否可以使用更高版本进行通信</p>
<p><img src="/2019/04/18/HTTP详解/1555502713615.png" alt="1555502713615"></p>
<h4 id="Via"><a href="#Via" class="headerlink" title="Via"></a>Via</h4><p>追踪客户端和服务器之间的请求和响应报文的传输路径。经过代理或网关时会现在Via中附加该服务器的信息，再转发。Via还可以避免请求回环的发生。常和TRACE方法一起使用</p>
<h3 id="请求首部字段"><a href="#请求首部字段" class="headerlink" title="请求首部字段"></a>请求首部字段</h3><h4 id="Accept"><a href="#Accept" class="headerlink" title="Accept"></a>Accept</h4><p>通知服务器用户代理能处理的媒体类型及相对优先级</p>
<p>可以使用q=来表示额外的权重 0-1 用分号隔离</p>
<h4 id="Accep-Charset"><a href="#Accep-Charset" class="headerlink" title="Accep-Charset"></a>Accep-Charset</h4><p>支持的字符集和相对优先级</p>
<h4 id="Accept-Encoding"><a href="#Accept-Encoding" class="headerlink" title="Accept-Encoding"></a>Accept-Encoding</h4><p>支持的内容编码和相对优先级</p>
<h4 id="Accept-Language"><a href="#Accept-Language" class="headerlink" title="Accept-Language"></a>Accept-Language</h4><p>支持的语言和相对优先级</p>
<h4 id="Authorization"><a href="#Authorization" class="headerlink" title="Authorization"></a>Authorization</h4><p>用户代理的认证信息</p>
<h4 id="Host"><a href="#Host" class="headerlink" title="Host"></a>Host</h4><p>虚拟主机运行在同一个IP上，用Host加以区分</p>
<h4 id="If-xxx"><a href="#If-xxx" class="headerlink" title="If-xxx"></a>If-xxx</h4><p>条件请求，只有当条件为真服务器才会处理请求</p>
<h4 id="If-Modified-Since"><a href="#If-Modified-Since" class="headerlink" title="If-Modified-Since"></a>If-Modified-Since</h4><p>告知服务器若字段值早于资源更新的时间则处理该请求，否则返回304</p>
<h4 id="Max-Forwards"><a href="#Max-Forwards" class="headerlink" title="Max-Forwards"></a>Max-Forwards</h4><p>可经过的服务器最大数目，每经过一个服务器-1</p>
<h4 id="User-Agent"><a href="#User-Agent" class="headerlink" title="User-Agent"></a>User-Agent</h4><p>传达浏览器的种类</p>
<h3 id="响应首部字段"><a href="#响应首部字段" class="headerlink" title="响应首部字段"></a>响应首部字段</h3><h4 id="ETag"><a href="#ETag" class="headerlink" title="ETag"></a>ETag</h4><p>告知客户端实体标识</p>
<h4 id="Location"><a href="#Location" class="headerlink" title="Location"></a>Location</h4><p>重定向时提供重定向的URI</p>
<h4 id="WWW-Authenticate"><a href="#WWW-Authenticate" class="headerlink" title="WWW-Authenticate"></a>WWW-Authenticate</h4><p>用于HTTP访问认证，告知客户端适用的认证方案</p>
<h3 id="实体首部字段"><a href="#实体首部字段" class="headerlink" title="实体首部字段"></a>实体首部字段</h3><h4 id="Allow"><a href="#Allow" class="headerlink" title="Allow"></a>Allow</h4><p>通知客户端能够支持URI指定资源的所有HTTP方法</p>
<h4 id="Content-Encoding"><a href="#Content-Encoding" class="headerlink" title="Content-Encoding"></a>Content-Encoding</h4><p>对实体的主题部分选用的内容编码方式，主要包括：gzip、compress、deflate、identity</p>
<h4 id="Content-Location"><a href="#Content-Location" class="headerlink" title="Content-Location"></a>Content-Location</h4><p>报文主体返回资源对应的URI</p>
<p>如返回的页面内容与实际请求的对象不同时会写明URI</p>
<h3 id="Cookie相关字段"><a href="#Cookie相关字段" class="headerlink" title="Cookie相关字段"></a>Cookie相关字段</h3><p>Cookie作用：对无状态协议HTTP的补充</p>
<h4 id="Set-Cookie"><a href="#Set-Cookie" class="headerlink" title="Set-Cookie"></a>Set-Cookie</h4><p><img src="/2019/04/18/HTTP详解/1555504189653.png" alt="1555504189653"></p>
<p><img src="/2019/04/18/HTTP详解/1555504200465.png" alt="1555504200465"></p>
<p>HttpOnly可以放止跨站脚本攻击（XSS）对Cookie信息的窃取，即无法通过doument.cookie获取Cookie内容</p>
<h4 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h4><h3 id="其他首部字段"><a href="#其他首部字段" class="headerlink" title="其他首部字段"></a>其他首部字段</h3><h4 id="X-XSS-Protection"><a href="#X-XSS-Protection" class="headerlink" title="X-XSS-Protection"></a>X-XSS-Protection</h4><p>用于控制浏览器XSS防护机制的开关</p>
<h2 id="Web安全"><a href="#Web安全" class="headerlink" title="Web安全"></a>Web安全</h2><h4 id="HTTP缺点"><a href="#HTTP缺点" class="headerlink" title="HTTP缺点"></a>HTTP缺点</h4><ul>
<li>明文通信，内容可能被窃听：SSL和TLS组合使用进行加密</li>
<li>不验证通信方身份，可能遭遇伪装：在开始通信前先确认服务器的证书</li>
<li>很迷报文的完整性，可能被篡改：散列值校验、数字签名</li>
</ul>
<h3 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h3><p>HTTPS = HTTP + 加密 + 认证 + 完整性保护</p>
<p><img src="/2019/04/18/HTTP详解/1555505046673.png" alt="1555505046673"></p>
<p>HTTPS采用混合加密机制，若密钥能实现安全交换，则考虑仅用公开密钥加密，但是其处理速度比共享密钥加密要慢</p>
<p><img src="/2019/04/18/HTTP详解/1555505242502.png" alt="1555505242502"></p>
<h3 id="证书"><a href="#证书" class="headerlink" title="证书"></a>证书</h3><p>作用：证明密钥正确性</p>
<p><img src="/2019/04/18/HTTP详解/1555505794662.png" alt="1555505794662"></p>
<h3 id="HTTPS通信"><a href="#HTTPS通信" class="headerlink" title="HTTPS通信"></a>HTTPS通信</h3><p><img src="/2019/04/18/HTTP详解/1555505910689.png" alt="1555505910689"></p>
<p><img src="/2019/04/18/HTTP详解/1555506163122.png" alt="1555506163122"></p>
<p><img src="/2019/04/18/HTTP详解/1555506189416.png" alt="1555506189416"></p>
<p>以上流程中，应用层发送数据时会附加MAC的报文摘要，查知报文是否被篡改，保护报文完整性</p>
<p>但HTTPS也存在速度慢，消耗CPU和你内存资源的问题</p>
<h2 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h2><h3 id="BASIC认证"><a href="#BASIC认证" class="headerlink" title="BASIC认证"></a>BASIC认证</h3><p><img src="/2019/04/18/HTTP详解/1555506908313.png" alt="1555506908313"></p>
<p>Base64不是加密处理，不需要附加信息即可解码</p>
<h3 id="DIGEST认证"><a href="#DIGEST认证" class="headerlink" title="DIGEST认证"></a>DIGEST认证</h3><p>使用质询/响应的方式，不直接发送明文密码。即一方先发送认证要求给另一方，接着使用从另一方接收到的质询码计算生成响应码，再返回给对方</p>
<p><img src="/2019/04/18/HTTP详解/1555507128268.png" alt="1555507128268"></p>
<h3 id="SSL客户端认证"><a href="#SSL客户端认证" class="headerlink" title="SSL客户端认证"></a>SSL客户端认证</h3><ul>
<li>接收到需要认证资源的请求，服务器发送Certificate Request报文，要求客户端提供客户端证书</li>
<li>客户端将证书信息以Client Certificate报文方式发送给服务器</li>
<li>服务器验证证书通过后方可领取其中公开密钥，开始HTTPS加密通信</li>
</ul>
<h2 id="基于HTTP功能的追加协议"><a href="#基于HTTP功能的追加协议" class="headerlink" title="基于HTTP功能的追加协议"></a>基于HTTP功能的追加协议</h2><h3 id="HTTP瓶颈"><a href="#HTTP瓶颈" class="headerlink" title="HTTP瓶颈"></a>HTTP瓶颈</h3><h4 id="Ajax"><a href="#Ajax" class="headerlink" title="Ajax"></a>Ajax</h4><p>通过js脚本调用和服务器进行http通信，可以从已加载完毕的Web页面上发起请求，只更新局部页面</p>
<h4 id="Comet"><a href="#Comet" class="headerlink" title="Comet"></a>Comet</h4><p>将响应置于挂起状态，当服务器有内容更新时再返回响应，但会消耗更多资源</p>
<h3 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h3><p>浏览器和服务器之间的全双工通信标准</p>
<p>优点：推送功能、减少通信量</p>
<p>在HTTP连接建立后需要一次握手来告知服务器通信协议改变，Upgrade:websocket</p>
<p><img src="/2019/04/18/HTTP详解/1555507877036.png" alt="1555507877036"></p>
<p>服务器可以调用websocket Api来发送数据</p>
<h2 id="Web攻击"><a href="#Web攻击" class="headerlink" title="Web攻击"></a>Web攻击</h2><h3 id="攻击"><a href="#攻击" class="headerlink" title="攻击"></a>攻击</h3><h4 id="跨站脚本攻击"><a href="#跨站脚本攻击" class="headerlink" title="跨站脚本攻击"></a>跨站脚本攻击</h4><p>恶意web用户将代码植入到提供给其它用户使用的页面中，包括HTML代码和客户端脚本，骗取个人信息、窃取Cookie等</p>
<h5 id="嵌入URL"><a href="#嵌入URL" class="headerlink" title="嵌入URL"></a>嵌入URL</h5><p><img src="/2019/04/18/HTTP详解/1555509389819.png" alt="1555509389819"></p>
<h5 id="窃取Cookie"><a href="#窃取Cookie" class="headerlink" title="窃取Cookie"></a>窃取Cookie</h5><p><img src="/2019/04/18/HTTP详解/1555509441737.png" alt="1555509441737"></p>
<p><img src="/2019/04/18/HTTP详解/1555509420941.png" alt="1555509420941"></p>
<h4 id="SQL注入攻击"><a href="#SQL注入攻击" class="headerlink" title="SQL注入攻击"></a>SQL注入攻击</h4><p><img src="/2019/04/18/HTTP详解/1555509497778.png" alt="1555509497778"></p>
<p>预防：变量采用占位符进行占位，实现转义</p>
<h4 id="OS命令注入攻击"><a href="#OS命令注入攻击" class="headerlink" title="OS命令注入攻击"></a>OS命令注入攻击</h4><p>执行非法的操作系统命令，在能调用Shell函数的地方就存在被攻击的风险</p>
<p><img src="/2019/04/18/HTTP详解/1555509669501.png" alt="1555509669501"></p>
<p><img src="/2019/04/18/HTTP详解/1555509677609.png" alt="1555509677609"></p>
<h4 id="HTTP首部注入攻击"><a href="#HTTP首部注入攻击" class="headerlink" title="HTTP首部注入攻击"></a>HTTP首部注入攻击</h4><p>在响应首部字段内插入换行或添加内容，可能设置任何Cookie信息、重定向至任意URL、显示任意主体（HTTP响应截断攻击）</p>
<p>HTTP响应截断攻击：插入%0D%0A%0D%0A，截断主体</p>
<h4 id="目录遍历攻击"><a href="#目录遍历攻击" class="headerlink" title="目录遍历攻击"></a>目录遍历攻击</h4><p>通过非法截断不公开的文件目录路径后形成攻击</p>
<p><img src="/2019/04/18/HTTP详解/1555509957604.png" alt="1555509957604"></p>
<h3 id="安全漏洞"><a href="#安全漏洞" class="headerlink" title="安全漏洞"></a>安全漏洞</h3><h4 id="强制浏览"><a href="#强制浏览" class="headerlink" title="强制浏览"></a>强制浏览</h4><p><img src="/2019/04/18/HTTP详解/1555510070913.png" alt="1555510070913"></p>
<h4 id="不正确的错误信息"><a href="#不正确的错误信息" class="headerlink" title="不正确的错误信息"></a>不正确的错误信息</h4><ul>
<li>Web应用抛出的错误信息：“未注册”信息可以被用于确认账号是否存在</li>
<li>数据库抛出的错误信息</li>
</ul>
<h4 id="开放重定向"><a href="#开放重定向" class="headerlink" title="开放重定向"></a>开放重定向</h4><p>对指定的任意URL做重定向</p>
<p><img src="/2019/04/18/HTTP详解/1555510186494.png" alt="1555510186494"></p>
<h4 id="会话管理疏忽"><a href="#会话管理疏忽" class="headerlink" title="会话管理疏忽"></a>会话管理疏忽</h4><p>获取会话ID的途径：推测、窃听、会话固定攻击</p>
<h5 id="会话固定攻击"><a href="#会话固定攻击" class="headerlink" title="会话固定攻击"></a>会话固定攻击</h5><p><img src="/2019/04/18/HTTP详解/1555556011317.png" alt="1555556011317"></p>
<h4 id="跨站点请求伪造"><a href="#跨站点请求伪造" class="headerlink" title="跨站点请求伪造"></a>跨站点请求伪造</h4><p>CSRF，利用已认证用户的权限更新设定信息、购买商品、发表评论等</p>
<p><img src="/2019/04/18/HTTP详解/1555557659047.png" alt="1555557659047"></p>
<h4 id="点击劫持"><a href="#点击劫持" class="headerlink" title="点击劫持"></a>点击劫持</h4><p>利用透明的按钮或链接做成陷阱覆盖在Web页面上，诱使用户点击</p>
<h4 id="Dos攻击"><a href="#Dos攻击" class="headerlink" title="Dos攻击"></a>Dos攻击</h4><p>集中利用访问请求导致资源过载；通过攻击安全漏洞使服务停止</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="访问控制（CORS）"><a href="#访问控制（CORS）" class="headerlink" title="访问控制（CORS）"></a>访问控制（CORS）</h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="noopener">HTTP访问控制（CORS）文档</a></p>
<h4 id="CORS中间件"><a href="#CORS中间件" class="headerlink" title="CORS中间件"></a>CORS中间件</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Cors</span><span class="params">()</span> <span class="title">gin</span>.<span class="title">HandlerFunc</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        method := c.Request.Method</span><br><span class="line">        fmt.Println(method)</span><br><span class="line">        c.Header(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>)</span><br><span class="line">        c.Header(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"Content-Type,AccessToken,X-CSRF-Token, Authorization, Token"</span>)</span><br><span class="line">        c.Header(<span class="string">"Access-Control-Allow-Methods"</span>, <span class="string">"POST, GET, OPTIONS, PUT, PATCH, DELETE"</span>)</span><br><span class="line">        c.Header(<span class="string">"Access-Control-Expose-Headers"</span>, <span class="string">"Content-Length, Access-Control-Allow-Origin, Access-Control-Allow-Headers, Content-Type"</span>)</span><br><span class="line">        c.Header(<span class="string">"Access-Control-Allow-Credentials"</span>, <span class="string">"true"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 放行所有OPTIONS方法，因为有的模板是要请求两次的</span></span><br><span class="line">        <span class="keyword">if</span> method == <span class="string">"OPTIONS"</span> &#123;</span><br><span class="line">            c.AbortWithStatus(http.StatusNoContent)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 处理请求</span></span><br><span class="line">        c.Next()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h3><p><a href="https://jwt.io/introduction/" target="_blank" rel="noopener">英文介绍</a></p>
<p><a href="http://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html" target="_blank" rel="noopener">阮一峰教程</a></p>
<h3 id="Localstorage"><a href="#Localstorage" class="headerlink" title="Localstorage"></a>Localstorage</h3><p><a href="https://juejin.im/post/5a9fcc5e51882555602074e3" target="_blank" rel="noopener">localstorage 必知必会</a></p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/localStorage" target="_blank" rel="noopener">Window.localStorage文档</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/20/SQL语句基础/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huangyt">
      <meta itemprop="description" content="Blogs of learning CS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/20/SQL语句基础/" class="post-title-link" itemprop="url">SQL语句基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-20 22:05:24" itemprop="dateCreated datePublished" datetime="2019-01-20T22:05:24+08:00">2019-01-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-07-19 16:42:15" itemprop="dateModified" datetime="2020-07-19T16:42:15+08:00">2020-07-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="SQL语句基础"><a href="#SQL语句基础" class="headerlink" title="SQL语句基础"></a>SQL语句基础</h2><h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h3><h4 id="选择数据库"><a href="#选择数据库" class="headerlink" title="选择数据库"></a>选择数据库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">USE crashcourse;</span><br></pre></td></tr></table></figure>
<h4 id="展示数据库"><a href="#展示数据库" class="headerlink" title="展示数据库"></a>展示数据库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW DATABASES;</span><br></pre></td></tr></table></figure>
<h4 id="展示表"><a href="#展示表" class="headerlink" title="展示表"></a>展示表</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW TABLES;</span><br></pre></td></tr></table></figure>
<h4 id="展示表列"><a href="#展示表列" class="headerlink" title="展示表列"></a>展示表列</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SHOW COLUMNS FROM customers;</span><br><span class="line">DESCRIBE customers;</span><br></pre></td></tr></table></figure>
<h3 id="检索数据"><a href="#检索数据" class="headerlink" title="检索数据"></a>检索数据</h3><h4 id="检索列"><a href="#检索列" class="headerlink" title="检索列"></a>检索列</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT prod_name, prod_name</span><br><span class="line">FROM products;</span><br></pre></td></tr></table></figure>
<ul>
<li>所有列：*</li>
</ul>
<h4 id="检索不重复的行"><a href="#检索不重复的行" class="headerlink" title="检索不重复的行"></a>检索不重复的行</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> vend_id</span><br><span class="line"><span class="keyword">FROM</span> products</span><br></pre></td></tr></table></figure>
<h4 id="限制结果（返回前几行或第几行）"><a href="#限制结果（返回前几行或第几行）" class="headerlink" title="限制结果（返回前几行或第几行）"></a>限制结果（返回前几行或第几行）</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> prod_name</span><br><span class="line"><span class="keyword">FROM</span> products</span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">5</span>,<span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>LIMIT的两种情况</p>
<ul>
<li>LIMIT 检索的开始行 行数</li>
<li>LIMIT 行数（）从第一行开始</li>
</ul>
<h3 id="排序数据"><a href="#排序数据" class="headerlink" title="排序数据"></a>排序数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> prod_name</span><br><span class="line"><span class="keyword">FROM</span> products</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> prod_name</span><br></pre></td></tr></table></figure>
<h4 id="按多个列排序"><a href="#按多个列排序" class="headerlink" title="按多个列排序"></a>按多个列排序</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> prod_name</span><br><span class="line"><span class="keyword">FROM</span> products</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> prod_name, prod_price</span><br></pre></td></tr></table></figure>
<h4 id="逆序"><a href="#逆序" class="headerlink" title="逆序"></a>逆序</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> prod_name</span><br><span class="line"><span class="keyword">FROM</span> products</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> prod_name <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure>
<ul>
<li>顺序关键字为ASC，顺序逆序关键字只应用到直接位于其前面的列名</li>
</ul>
<h3 id="过滤数据"><a href="#过滤数据" class="headerlink" title="过滤数据"></a>过滤数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> prod_name</span><br><span class="line"><span class="keyword">FROM</span> products</span><br><span class="line"><span class="keyword">WHERE</span> prod_name = <span class="keyword">test</span></span><br></pre></td></tr></table></figure>
<h4 id="WHERE子句操作符"><a href="#WHERE子句操作符" class="headerlink" title="WHERE子句操作符"></a>WHERE子句操作符</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">=, &lt;&gt;, !=, &lt;, &lt;=, &gt;, &gt;=, BETWEEN, IS NULL</span><br></pre></td></tr></table></figure>
<ul>
<li>在过滤数据时，无论匹配过滤还是不匹配过滤都不会返回NULL值的行</li>
</ul>
<h4 id="组合过滤关键字"><a href="#组合过滤关键字" class="headerlink" title="组合过滤关键字"></a>组合过滤关键字</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AND, OR, IN， NOT</span><br></pre></td></tr></table></figure>
<ul>
<li><p>AND的优先级比OR高</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WHERE vend_id = 1002 OR vend_id = 1003 AND prod_price &gt;= 10</span><br></pre></td></tr></table></figure>
</li>
<li><p>IN表示范围中的每个条件都可以进行匹配</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WHERE vend_id IN (1002, 1003)</span><br></pre></td></tr></table></figure>
<p>相当于</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WHERE vned_id = 1002 OR vwnd_id = 1003</span><br></pre></td></tr></table></figure>
<p>IN可以包含其他SELECT语句</p>
</li>
</ul>
<h3 id="用通配符过滤"><a href="#用通配符过滤" class="headerlink" title="用通配符过滤"></a>用通配符过滤</h3><p>通配符：匹配值的一部分的特殊字符</p>
<h4 id="LIKE操作符"><a href="#LIKE操作符" class="headerlink" title="LIKE操作符"></a>LIKE操作符</h4><h5 id="通配符"><a href="#通配符" class="headerlink" title="%通配符"></a>%通配符</h5><p>%表示任何字符出现任意次数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">所有以jet开头的产品</span><br><span class="line"><span class="keyword">SELECT</span> prod_id, prod_name</span><br><span class="line"><span class="keyword">FROM</span> products</span><br><span class="line"><span class="keyword">WHERE</span> prod_name <span class="keyword">LIKE</span> <span class="string">'jet%'</span></span><br><span class="line"></span><br><span class="line">在任何位置包含文本jet的值</span><br><span class="line">...</span><br><span class="line"><span class="keyword">WHERE</span> prod_name <span class="keyword">LIKE</span> <span class="string">'%jet%'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>区分大小写</li>
<li>%能匹配0、1或多个字符</li>
<li>尾空格会干扰通配符匹配，解决方法：在搜索模式最后附加一个%</li>
<li>%通配符不能匹配NULL</li>
</ul>
<h5 id="通配符-1"><a href="#通配符-1" class="headerlink" title="_通配符"></a>_通配符</h5><p>用法类似%，但只匹配单个字符</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">产品名形如 1 ton anvil, e ton_anvil</span><br><span class="line"><span class="keyword">SELECT</span> prod_id, prod_name</span><br><span class="line"><span class="keyword">FROM</span> products</span><br><span class="line"><span class="keyword">WHERE</span> prod_name <span class="keyword">LIKE</span> <span class="string">'_ ton anvil'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通配符搜索的处理较慢，不要过度使用通配符，若其他操作符能做到，就用其他操作符</li>
<li>除非必要，否则不要把通配符用在搜索模式的开始处，搜索起来最慢</li>
</ul>
<h3 id="用正则表达式进行搜索"><a href="#用正则表达式进行搜索" class="headerlink" title="用正则表达式进行搜索"></a>用正则表达式进行搜索</h3><h4 id="REGEXP"><a href="#REGEXP" class="headerlink" title="REGEXP"></a>REGEXP</h4><p>REGEXP后所跟的东西作为正则表达式</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> prod_name</span><br><span class="line"><span class="keyword">FROM</span> products</span><br><span class="line"><span class="keyword">WHERE</span> prod_name REGEXP <span class="string">'1000'</span></span><br></pre></td></tr></table></figure>
<h4 id><a href="#" class="headerlink" title="."></a>.</h4><p>.在正则表达式中表示匹配任意一个字符</p>
<ul>
<li>LIKE和REGEXP的区别：<ul>
<li>LIKE匹配整个列（整个串），REGEXP在列值内进行匹配（子串）</li>
<li><strong>正则表达式不区别大小写</strong></li>
</ul>
</li>
</ul>
<h4 id="-1"><a href="#-1" class="headerlink" title="|"></a>|</h4><p>用于OR匹配</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WHERE prod_name REGEXP '1000|2000|3000'</span><br></pre></td></tr></table></figure>
<h4 id="-2"><a href="#-2" class="headerlink" title="[]"></a>[]</h4><p>匹配几个字符之一</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WHERE prod_name REGEXP '[123] Ton'</span><br></pre></td></tr></table></figure>
<h4 id="-3"><a href="#-3" class="headerlink" title="[-]"></a>[-]</h4><p>匹配范围</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WHERE prod_name REGEXP '[1-5]'</span><br><span class="line">等价于</span><br><span class="line">WHERE prod_name REGEXP ‘1|2|3|4|5'</span><br></pre></td></tr></table></figure>
<h4 id="特殊字符"><a href="#特殊字符" class="headerlink" title="特殊字符"></a>特殊字符</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\\.表示查找.</span><br><span class="line">\\-表示查找-</span><br><span class="line">\\\表示查找\</span><br></pre></td></tr></table></figure>
<h4 id="空白元字符"><a href="#空白元字符" class="headerlink" title="空白元字符"></a>空白元字符</h4><table>
<thead>
<tr>
<th>元字符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>\ \ f</td>
<td>换页</td>
</tr>
<tr>
<td>\ \ n</td>
<td>换行</td>
</tr>
<tr>
<td>\ \ r</td>
<td>回车</td>
</tr>
<tr>
<td>\ \ t</td>
<td>制表</td>
</tr>
<tr>
<td>\ \ v</td>
<td>纵向制表</td>
</tr>
</tbody>
</table>
<h4 id="匹配字符类"><a href="#匹配字符类" class="headerlink" title="匹配字符类"></a>匹配字符类</h4><table>
<thead>
<tr>
<th>类</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>[:alnum:]</td>
<td>任意字母和数字（同[a-zA-Z0-9]）</td>
</tr>
<tr>
<td>[:alpha:]</td>
<td>任意字符（同[a-zA-Z]）</td>
</tr>
<tr>
<td>[:blank:]</td>
<td>空格和制表（同[\t]）</td>
</tr>
<tr>
<td>[:cntrl:]</td>
<td>ASCII控制字符（ASCII 0到31和127）</td>
</tr>
<tr>
<td>[:digit:]</td>
<td>任意数字（同[0-9]）</td>
</tr>
<tr>
<td>[:graph:]</td>
<td>与[:print:]相同，但不包括空格</td>
</tr>
<tr>
<td>[:lower:]</td>
<td>任意小写字母（同[a-z]）</td>
</tr>
<tr>
<td>[:print:]</td>
<td>任意可打印字符</td>
</tr>
<tr>
<td>[:punct:]</td>
<td>既不在[:alnum:]又不在[:cntrl:]中的任意字符</td>
</tr>
<tr>
<td>[:space:]</td>
<td>包括空格在内的任意空白字符（同[\f\n\r\t\v]）</td>
</tr>
<tr>
<td>[:upper:]</td>
<td>任意大写字母（同[A-Z]）</td>
</tr>
<tr>
<td>[:xdigit:]</td>
<td>任意十六进制数字（同[a-fA-F0-9]）</td>
</tr>
</tbody>
</table>
<h4 id="重复元字符"><a href="#重复元字符" class="headerlink" title="重复元字符"></a>重复元字符</h4><table>
<thead>
<tr>
<th>元字符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>*</td>
<td>0个或多个匹配</td>
</tr>
<tr>
<td>+</td>
<td>1个或多个匹配（等于{1,}）</td>
</tr>
<tr>
<td>?</td>
<td>0个或1个匹配（等于{0,1}）</td>
</tr>
<tr>
<td>{n}</td>
<td>指定数目的匹配</td>
</tr>
<tr>
<td>{n,}</td>
<td>不少于指定数目的匹配</td>
</tr>
<tr>
<td>{n,m}</td>
<td>匹配数目的范围（m不超过255）</td>
</tr>
</tbody>
</table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">匹配形如</span><br><span class="line">TNT (1 stick)</span><br><span class="line">TNT (5 sticks)</span><br><span class="line">REGEXP '\\([0-9] sticks?\\)'</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">匹配连在一起的4位数字</span><br><span class="line">REGEXP '[[:digit:]]&#123;4&#125;'</span><br></pre></td></tr></table></figure>
<h4 id="定位符"><a href="#定位符" class="headerlink" title="定位符"></a>定位符</h4><p>匹配特定位置的文本</p>
<table>
<thead>
<tr>
<th>元字符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>^</td>
<td>文本的开始</td>
</tr>
<tr>
<td>$</td>
<td>文本的结尾</td>
</tr>
<tr>
<td>[[:&lt;:]]</td>
<td>词的开始</td>
</tr>
<tr>
<td>[[:&gt;:]]</td>
<td>词的结尾</td>
</tr>
</tbody>
</table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">匹配以数字或.开头的列值</span><br><span class="line">REGEXP '^[0-9\\.]'</span><br></pre></td></tr></table></figure>
<h3 id="计算字段"><a href="#计算字段" class="headerlink" title="计算字段"></a>计算字段</h3><h4 id="拼接字段"><a href="#拼接字段" class="headerlink" title="拼接字段"></a>拼接字段</h4><p>Concat()拼接两个列，各个串之间用逗号分隔</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">Concat</span>(vend_name, <span class="string">'('</span>, vend_country, <span class="string">')'</span>)</span><br><span class="line"><span class="keyword">FROM</span> vendors</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> vend_name</span><br></pre></td></tr></table></figure>
<ul>
<li>多数DBMS用+或||来实现拼接，MySQL用Concat()实现</li>
</ul>
<p>RTrim()用于删除数据右侧多余的空格来整理数据，LTrim()删除左侧多余空格</p>
<h4 id="使用别名"><a href="#使用别名" class="headerlink" title="使用别名"></a>使用别名</h4><p>AS赋予别名</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">Concat</span>(vend_name, <span class="string">'('</span>, vend_country, <span class="string">')'</span>) <span class="keyword">AS</span> vend_title</span><br><span class="line"><span class="keyword">FROM</span> vendors</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> vend_name</span><br></pre></td></tr></table></figure>
<h4 id="算术运算"><a href="#算术运算" class="headerlink" title="算术运算"></a>算术运算</h4><p>可以在SELECT中使用加减乘除</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> quantity*item <span class="keyword">AS</span> expanded_price</span><br><span class="line"><span class="keyword">FROM</span> orderitems</span><br><span class="line"><span class="keyword">WHERE</span> order_num = <span class="number">20005</span></span><br></pre></td></tr></table></figure>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><h4 id="文本处理函数"><a href="#文本处理函数" class="headerlink" title="文本处理函数"></a>文本处理函数</h4><table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Left()</td>
<td>返回串左边的字符</td>
</tr>
<tr>
<td>Length()</td>
<td>返回串的长度</td>
</tr>
<tr>
<td>Locate()</td>
<td>找出串的一个子串</td>
</tr>
<tr>
<td>Lower()</td>
<td>将串转换为小写</td>
</tr>
<tr>
<td>LTrim()</td>
<td>去掉串左边的空格</td>
</tr>
<tr>
<td>Right()</td>
<td>返回串右边的字符</td>
</tr>
<tr>
<td>RTrim()</td>
<td>去掉串右边的空格</td>
</tr>
<tr>
<td>Soundex()</td>
<td>返回串的SOUNDEX值</td>
</tr>
<tr>
<td>SubString()</td>
<td>返回子串的字符</td>
</tr>
<tr>
<td>Upper()</td>
<td>将串转换为大写</td>
</tr>
</tbody>
</table>
<h4 id="日期和时间处理函数"><a href="#日期和时间处理函数" class="headerlink" title="日期和时间处理函数"></a>日期和时间处理函数</h4><table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>AddDate()</td>
<td>增加一个日期（天、周等）</td>
</tr>
<tr>
<td>AddTime()</td>
<td>增加一个时间（时、分等）</td>
</tr>
<tr>
<td>CurDate()</td>
<td>返回当前日期</td>
</tr>
<tr>
<td>CurTime()</td>
<td>返回当前时间</td>
</tr>
<tr>
<td>Date()</td>
<td>返回日期时间的日期部分</td>
</tr>
<tr>
<td>DateDiff()</td>
<td>计算两个日期之差</td>
</tr>
<tr>
<td>Date_Add()</td>
<td>高度灵活的日期运算函数</td>
</tr>
<tr>
<td>Date_Format()</td>
<td>返回一个格式化的日期或时间串</td>
</tr>
<tr>
<td>Day()</td>
<td>返回一个日期的天数部分</td>
</tr>
<tr>
<td>DayOfWeek()</td>
<td>对于一个日期，返回对应的星期几</td>
</tr>
<tr>
<td>Hour()</td>
<td>返回一个时间的小时部分</td>
</tr>
<tr>
<td>Minute()</td>
<td>返回一个时间的分钟部分</td>
</tr>
<tr>
<td>Month()</td>
<td>返回一个日期的月份部分</td>
</tr>
<tr>
<td>Now()</td>
<td>返回当前日期和时间</td>
</tr>
<tr>
<td>Second()</td>
<td>返回一个时间的秒部分</td>
</tr>
<tr>
<td>Time()</td>
<td>返回一个日期时间的时间部分</td>
</tr>
<tr>
<td>Year()</td>
<td>返回一个日期的年份部分</td>
</tr>
</tbody>
</table>
<ul>
<li><p>检索时间时要注意转化</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> cust_id, order_num</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">WHERE</span> order_date = <span class="string">'2005-09-01'</span></span><br></pre></td></tr></table></figure>
<p>若order_date = ‘2005-09-01 11:30:05’则匹配失败</p>
<p>应改为</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> cust_id, order_num</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">WHERE</span> <span class="built_in">Date</span>(order_date) = <span class="string">'2005-09-01'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>检索2005年9月的所有订单</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> cust_id, order_num</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">WHERE</span> <span class="built_in">Date</span>(order_date) <span class="keyword">BETWEEN</span> <span class="string">'2005-09-01'</span> <span class="keyword">AND</span> <span class="string">'2005-09-30'</span></span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> cust_id, order_num</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">Year</span>(order_date) = <span class="number">2005</span> <span class="keyword">AND</span> <span class="keyword">Month</span>(order_date) = <span class="number">9</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="数值处理函数"><a href="#数值处理函数" class="headerlink" title="数值处理函数"></a>数值处理函数</h4><table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Abs()</td>
<td>返回一个数的绝对值</td>
</tr>
<tr>
<td>Cos()</td>
<td>返回一个角度的余弦</td>
</tr>
<tr>
<td>Exp()</td>
<td>返回一个数的指数值</td>
</tr>
<tr>
<td>Mod()</td>
<td>返回除操作的余数</td>
</tr>
<tr>
<td>Pi()</td>
<td>返回圆周率</td>
</tr>
<tr>
<td>Rand()</td>
<td>返回一个随机数</td>
</tr>
<tr>
<td>Sin()</td>
<td>返回一个角度的正弦</td>
</tr>
<tr>
<td>Sqrt()</td>
<td>返回一个数的平方根</td>
</tr>
<tr>
<td>Tan()</td>
<td>返回一个角度的正切</td>
</tr>
</tbody>
</table>
<h3 id="汇总数据"><a href="#汇总数据" class="headerlink" title="汇总数据"></a>汇总数据</h3><h4 id="聚集函数"><a href="#聚集函数" class="headerlink" title="聚集函数"></a>聚集函数</h4><table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>AVG()</td>
<td>返回某列的平均值</td>
</tr>
<tr>
<td>COUNT()</td>
<td>返回某列的行数</td>
</tr>
<tr>
<td>MAX()</td>
<td>返回某列的最大值</td>
</tr>
<tr>
<td>MIN()</td>
<td>返回某列的最小值</td>
</tr>
<tr>
<td>SUM()</td>
<td>返回某列值之和</td>
</tr>
</tbody>
</table>
<ul>
<li>如果指定列名，则指定列的值为空的行被COUNT()函数忽略，但如果COUNT()函数中用的是*，则不忽略</li>
<li>MAX()、MIN()、SUM()函数忽略值为NULL的行</li>
</ul>
<h4 id="聚集不同的值"><a href="#聚集不同的值" class="headerlink" title="聚集不同的值"></a>聚集不同的值</h4><p>指定DISTINCT参数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">AVG</span>(<span class="keyword">DISTINCT</span> prod_price) <span class="keyword">AS</span> avg_price</span><br><span class="line"><span class="keyword">FROM</span> products</span><br><span class="line"><span class="keyword">WHERE</span> vend_id = <span class="number">1003</span></span><br></pre></td></tr></table></figure>
<ul>
<li>DISTINCT必须使用列名，不能用于计算或表达式或*</li>
<li>DISTINCT一般只用于COUNT()，用于MIN()，MAX()无意义</li>
</ul>
<h3 id="分组数据"><a href="#分组数据" class="headerlink" title="分组数据"></a>分组数据</h3><p>分组将数据分为多个逻辑组，便于对每个组进行聚集计算</p>
<h4 id="创建分组"><a href="#创建分组" class="headerlink" title="创建分组"></a>创建分组</h4><p>用GROUP BY创建分组</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> vend_id, <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> num_prods</span><br><span class="line"><span class="keyword">FROM</span> products</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> vend_id</span><br></pre></td></tr></table></figure>
<ul>
<li>GROUP BY子句必须出现在WHERE子句之后，ORDER BY子句之前</li>
<li>如果分组列中具有NULL值，则NULL将作为一个分组返回。如果列中有多行NULL值，它们将分为一组</li>
</ul>
<h4 id="过滤分组"><a href="#过滤分组" class="headerlink" title="过滤分组"></a>过滤分组</h4><p>HAVING过滤分组（WHERE过滤行）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> cust_id, <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> orders</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> vend_id</span><br><span class="line">HAING <span class="keyword">COUNT</span>(*) &gt;= <span class="number">2</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>HAVING和WHERE的区别：WHERE在数据分组之前过滤，HAVING在分组后进行过滤;WHERE排除的行不包括在分组中</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> cust_id, <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> orders</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">WHERE</span> prod_price &gt;= <span class="number">10</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> vend_id</span><br><span class="line">HAING <span class="keyword">COUNT</span>(*) &gt;= <span class="number">2</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> cust_id</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">WHERE</span> order_num <span class="keyword">IN</span>(<span class="keyword">SELECT</span> order_num</span><br><span class="line">                  <span class="keyword">FROM</span> orderitems</span><br><span class="line">                  <span class="keyword">WHERE</span> prod_id = <span class="string">'TNT2'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="联结表"><a href="#联结表" class="headerlink" title="联结表"></a>联结表</h3><h4 id="内部联结"><a href="#内部联结" class="headerlink" title="内部联结"></a>内部联结</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> vend_name, prod_name, prod_price</span><br><span class="line"><span class="keyword">FROM</span> vendors v <span class="keyword">INNER</span> <span class="keyword">JOIN</span> products p</span><br><span class="line"><span class="keyword">ON</span> v.vend_id = p.vend_id</span><br></pre></td></tr></table></figure>
<h3 id="创建高级联结"><a href="#创建高级联结" class="headerlink" title="创建高级联结"></a>创建高级联结</h3><h4 id="自联结"><a href="#自联结" class="headerlink" title="自联结"></a>自联结</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> p1.prod_id, p1.prod_name</span><br><span class="line"><span class="keyword">FROM</span> products <span class="keyword">AS</span> p1, products <span class="keyword">AS</span> p2</span><br><span class="line"><span class="keyword">WHERE</span> p1.vend_id = p2.vend_id</span><br><span class="line"><span class="keyword">AND</span> p2.prod_id = <span class="string">'DTNTR'</span></span><br></pre></td></tr></table></figure>
<h4 id="外部联结"><a href="#外部联结" class="headerlink" title="外部联结"></a>外部联结</h4><p>包含在相关表中没有关联行的行：OUT JOIN</p>
<p>在使用OUTER JOIN语法时，必须使用RIGHT或LEFT关键字指定包括其所有行的表</p>
<ul>
<li>LEFT JOIN从左边的表中选择所有行</li>
<li>RIGHT JOIN从右边的表中选择所有行</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> customers.cust_id, orders.order_num</span><br><span class="line"><span class="keyword">FROM</span> customers <span class="keyword">RIGHT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> orders</span><br><span class="line"><span class="keyword">ON</span> orders.cust_id = customers.cust_id</span><br></pre></td></tr></table></figure>
<h3 id="组合查询"><a href="#组合查询" class="headerlink" title="组合查询"></a>组合查询</h3><h4 id="合并结果集"><a href="#合并结果集" class="headerlink" title="合并结果集"></a>合并结果集</h4><p>在各语句之间放上关键字UNION</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> vend_id, prod_id, prod_price</span><br><span class="line"><span class="keyword">FROM</span> products</span><br><span class="line"><span class="keyword">WHERE</span> prod_price &lt;= <span class="number">5</span></span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"><span class="keyword">SELECT</span> vend_id, prod_id, prod_price</span><br><span class="line"><span class="keyword">FROM</span> products</span><br><span class="line"><span class="keyword">WHERE</span> vend_id <span class="keyword">IN</span> (<span class="number">1001</span>, <span class="number">1002</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>UNION中的每个查询必须包含相同的列、表达式或聚集函数（不过各个列不需要以相同的次序列出）</li>
<li>列数据类型必须兼容：类型不必完全相同，但必须是DBMS可以隐含地转换的类型（例如，不同的数值类型或不同的日期类型）</li>
<li>UNION从查询结果集中自动去除了重复的行，如果想返回所有匹配行，可使用UNION ALL而不是UNION</li>
</ul>
<h4 id="排序组合查询"><a href="#排序组合查询" class="headerlink" title="排序组合查询"></a>排序组合查询</h4><p>在用UNION组合查询时，只能使用一条ORDER BY子句，它必须出现在最后一条SELECT语句之后</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> vend_id, prod_id, prod_price</span><br><span class="line"><span class="keyword">FROM</span> products</span><br><span class="line"><span class="keyword">WHERE</span> prod_price &lt;= <span class="number">5</span></span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"><span class="keyword">SELECT</span> vend_id, prod_id, prod_price</span><br><span class="line"><span class="keyword">FROM</span> products</span><br><span class="line"><span class="keyword">WHERE</span> vend_id <span class="keyword">IN</span> (<span class="number">1001</span>, <span class="number">1002</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> vend_id, prod_price</span><br></pre></td></tr></table></figure>
<h3 id="全文本搜索"><a href="#全文本搜索" class="headerlink" title="全文本搜索"></a>全文本搜索</h3><p>两个最常使用的引擎为MyISAM和InnoDB，前者支持全文本搜索，而后者不支持</p>
<p>正则搜索的限制：</p>
<ul>
<li>性能</li>
<li>难以明确控制</li>
</ul>
<p>全文本搜索中数据是索引的，所以速度很快</p>
<h4 id="启用全文本搜索支持"><a href="#启用全文本搜索支持" class="headerlink" title="启用全文本搜索支持"></a>启用全文本搜索支持</h4><p>在CREATE时FULLTEXT(note_text)</p>
<h4 id="进行全文本搜索"><a href="#进行全文本搜索" class="headerlink" title="进行全文本搜索"></a>进行全文本搜索</h4><p>Match()指定被搜索的列，Against()指定要使用的搜索表达式</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> note_text</span><br><span class="line"><span class="keyword">FROM</span> productnotes</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">Match</span>(note_text) Against(<span class="string">'rabbit'</span>)</span><br><span class="line">可以用<span class="keyword">LIKE</span></span><br><span class="line"><span class="keyword">WHERE</span> note_text <span class="keyword">LIKE</span> <span class="string">'%rabbit%'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>传递给Match()的值必须与FULLTEXT()定义的相同，若指定多个列，就必须列出它们（而且次序正确）</li>
<li>搜索不区分大小写</li>
</ul>
<h3 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h3><h4 id="插入完整的行"><a href="#插入完整的行" class="headerlink" title="插入完整的行"></a>插入完整的行</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> customers</span><br><span class="line"><span class="keyword">VALUES</span>(<span class="literal">NULL</span>,</span><br><span class="line">      <span class="string">'Pep E'</span>,</span><br><span class="line">      <span class="string">'100 Main Street'</span>,</span><br><span class="line">      <span class="string">'Los Angeles'</span>,</span><br><span class="line">      <span class="string">'CA'</span>,</span><br><span class="line">      <span class="string">'90046'</span>,</span><br><span class="line">      <span class="string">'USA'</span>,</span><br><span class="line">      <span class="literal">NULL</span>,</span><br><span class="line">      <span class="literal">NULL</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>没有输出</li>
<li>可以省略都写列，但必须允许为NULL或给出默认值</li>
</ul>
<h4 id="插入多个行"><a href="#插入多个行" class="headerlink" title="插入多个行"></a>插入多个行</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> customers</span><br><span class="line"><span class="keyword">VALUES</span>(<span class="literal">NULL</span>,</span><br><span class="line">      <span class="string">'Pep E'</span>,</span><br><span class="line">      <span class="string">'100 Main Street'</span>,</span><br><span class="line">      <span class="string">'Los Angeles'</span>,</span><br><span class="line">      <span class="string">'CA'</span>,</span><br><span class="line">      <span class="string">'90046'</span>,</span><br><span class="line">      <span class="string">'USA'</span>,</span><br><span class="line">      <span class="literal">NULL</span>,</span><br><span class="line">      <span class="literal">NULL</span>),</span><br><span class="line">      (<span class="literal">NULL</span>,</span><br><span class="line">      <span class="string">'Pep E'</span>,</span><br><span class="line">      <span class="string">'100 Main Street'</span>,</span><br><span class="line">      <span class="string">'Los Angeles'</span>,</span><br><span class="line">      <span class="string">'CA'</span>,</span><br><span class="line">      <span class="string">'90046'</span>,</span><br><span class="line">      <span class="string">'USA'</span>,</span><br><span class="line">      <span class="literal">NULL</span>,</span><br><span class="line">      <span class="literal">NULL</span>),</span><br></pre></td></tr></table></figure>
<h4 id="插入检索的数据"><a href="#插入检索的数据" class="headerlink" title="插入检索的数据"></a>插入检索的数据</h4><p>不一定要求列名匹配</p>
<h3 id="更新和删除数据"><a href="#更新和删除数据" class="headerlink" title="更新和删除数据"></a>更新和删除数据</h3><h4 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h4><p>更新时注意不要省略WHERE子句，否则会更新所有行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> customers</span><br><span class="line"><span class="keyword">SET</span> cust_email = <span class="string">'elmer@qq.com'</span></span><br><span class="line">	cust_name = <span class="string">'Wynton'</span></span><br><span class="line"><span class="keyword">WHERE</span> cust_id = <span class="number">10005</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以使用子查询，使得能用检索出来的数据更新列数据</li>
<li>IGNORE可以在更新多行时，即使发生错误也能继续更新，否则整个UPDATE操作将被取消</li>
<li>删除某个列的值可以设置其为NULL（若允许）</li>
</ul>
<h4 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> customers</span><br><span class="line"><span class="keyword">WHERE</span> cust_id = <span class="number">10006</span></span><br></pre></td></tr></table></figure>
<p><strong>更新和删除时先用SELECT进行测试</strong></p>
<h3 id="创建和操纵表"><a href="#创建和操纵表" class="headerlink" title="创建和操纵表"></a>创建和操纵表</h3><h4 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> customers</span><br><span class="line">(</span><br><span class="line">	cust_id			<span class="built_in">int</span>			<span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    cust_name		<span class="built_in">char</span>(<span class="number">50</span>)	<span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cust_address 	<span class="built_in">char</span>(<span class="number">50</span>)	<span class="literal">NULL</span>,</span><br><span class="line">    cust_city 		<span class="built_in">char</span>(<span class="number">50</span>)	<span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'Los'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (cust_id)</span><br><span class="line">)<span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span></span><br></pre></td></tr></table></figure>
<ul>
<li>AUTO_INCREMENT表示，本列每当增加一行时自动增量</li>
<li>每个表只允许一个AUTO_INCREMENT列，而且它必须被索引（如，通过使它成为主键）</li>
<li>默认值用DEFAULT指定</li>
<li>ENGINE指定引擎类型</li>
</ul>
<h4 id="更新表定义"><a href="#更新表定义" class="headerlink" title="更新表定义"></a>更新表定义</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> vendors</span><br><span class="line"><span class="keyword">ADD</span> vend_phone <span class="built_in">CHAR</span>(<span class="number">20</span>)</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">COLUMN</span> vend_phone</span><br></pre></td></tr></table></figure>
<h4 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> customers2</span><br></pre></td></tr></table></figure>
<h4 id="重命名表"><a href="#重命名表" class="headerlink" title="重命名表"></a>重命名表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RENAME</span> <span class="keyword">TABLE</span> customers <span class="keyword">TO</span> customers2</span><br></pre></td></tr></table></figure>
<h3 id="使用视图"><a href="#使用视图" class="headerlink" title="使用视图"></a>使用视图</h3><h4 id="视图常见应用"><a href="#视图常见应用" class="headerlink" title="视图常见应用"></a>视图常见应用</h4><ul>
<li>重用SQL语句</li>
<li>简化复杂的SQL操作。在编写查询后，可以方便地重用它而不必知道它的基本查询细节</li>
<li>使用表的组成部分而不是整个表</li>
<li>保护数据。可以给用户授予表的特定部分的访问权限而不是整个表的访问权限</li>
<li>更改数据格式和表示。视图可返回与底层表的表示和格式不同的数据</li>
</ul>
<h4 id="使用视图-1"><a href="#使用视图-1" class="headerlink" title="使用视图"></a>使用视图</h4><ul>
<li>视图用CREATE VIEW语句来创建</li>
<li>使用SHOW CREATE VIEW viewname；来查看创建视图的语句</li>
<li>用DROP删除视图，其语法为DROP VIEW viewname;</li>
<li>更新视图时，可以先用DROP再用CREATE，也可以直接用CREATE ORREPLACE VIEW</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> productcustomers <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> cust_name,...</span><br><span class="line"><span class="keyword">FROM</span> customers,...</span><br><span class="line"><span class="keyword">WHERE</span> ...</span><br></pre></td></tr></table></figure>
<ul>
<li>使用视图可以一次性编写基础SQL，根据需要多次使用</li>
</ul>
<h4 id="利用视图格式化检索出的数据"><a href="#利用视图格式化检索出的数据" class="headerlink" title="利用视图格式化检索出的数据"></a>利用视图格式化检索出的数据</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> productcustomers <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">Concat</span>(<span class="keyword">RTrim</span>(cust_name),...) <span class="keyword">AS</span> vend_title</span><br><span class="line"><span class="keyword">FROM</span> customers,...</span><br><span class="line"><span class="keyword">WHERE</span> ...</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> ...</span><br></pre></td></tr></table></figure>
<h4 id="利用视图过滤不想要的数据"><a href="#利用视图过滤不想要的数据" class="headerlink" title="利用视图过滤不想要的数据"></a>利用视图过滤不想要的数据</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> customereamillist <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> cust_id, cust_name, cust_email</span><br><span class="line"><span class="keyword">FROM</span> customers</span><br><span class="line"><span class="keyword">WHERE</span> cust_email <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br></pre></td></tr></table></figure>
<h4 id="利用视图与计算字段"><a href="#利用视图与计算字段" class="headerlink" title="利用视图与计算字段"></a>利用视图与计算字段</h4><p>…</p>
<h3 id="使用存储过程"><a href="#使用存储过程" class="headerlink" title="使用存储过程"></a>使用存储过程</h3><p>优点：简单、安全、高性能</p>
<h4 id="执行存储过程"><a href="#执行存储过程" class="headerlink" title="执行存储过程"></a>执行存储过程</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> productpricing(@pricelow</span><br><span class="line">                   	@pricehigh</span><br><span class="line">                   	@priceaverage)</span><br></pre></td></tr></table></figure>
<h4 id="创建存储过程"><a href="#创建存储过程" class="headerlink" title="创建存储过程"></a>创建存储过程</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> productpricing(</span><br><span class="line">	<span class="keyword">OUT</span> pl <span class="built_in">DECIMAL</span>(<span class="number">8</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">OUT</span> ph <span class="built_in">DECIMAL</span>(<span class="number">8</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">OUT</span> pa <span class="built_in">DECIMAL</span>(<span class="number">8</span>, <span class="number">2</span>)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line">	<span class="keyword">SELECT</span> <span class="keyword">MIN</span>(prod_price)</span><br><span class="line">	<span class="keyword">INTO</span> pl</span><br><span class="line">	<span class="keyword">FROM</span> products;</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="keyword">MAX</span>(prod_price)</span><br><span class="line">	<span class="keyword">INTO</span> ph</span><br><span class="line">	<span class="keyword">FROM</span> products;</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="keyword">AVG</span>(prod_price) </span><br><span class="line">	<span class="keyword">INTO</span> pa</span><br><span class="line">	<span class="keyword">FROM</span> products;</span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>
<h3 id="使用游标"><a href="#使用游标" class="headerlink" title="使用游标"></a>使用游标</h3><h4 id="使用游标的原因"><a href="#使用游标的原因" class="headerlink" title="使用游标的原因"></a>使用游标的原因</h4><p>使用简单的SELECT语句，例如，没有办法得到第一行、下一行或前10行，也不存在每次一行<br>地处理所有行的简单方法（相对于成批地处理它们）<br>有时，需要在检索出来的行中前进或后退一行或多行，游标（cursor）是一个存储在MySQL服务器上的数据库查询，它不是一条SELECT语句，而是被该语句检索出来的结果集</p>
<h4 id="创建游标"><a href="#创建游标" class="headerlink" title="创建游标"></a>创建游标</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> processorders()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span> ordernumbers <span class="keyword">CURSOR</span></span><br><span class="line">	<span class="keyword">FOR</span></span><br><span class="line">	<span class="keyword">SELECT</span> order_num <span class="keyword">FROM</span> orders;</span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>
<h4 id="打开和关闭游标"><a href="#打开和关闭游标" class="headerlink" title="打开和关闭游标"></a>打开和关闭游标</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OPEN ordernumbers</span><br><span class="line">CLOSE ordernumbers</span><br></pre></td></tr></table></figure>
<h4 id="使用游标数据"><a href="#使用游标数据" class="headerlink" title="使用游标数据"></a>使用游标数据</h4><p>将数据检索到一个o的局部声明的变量中</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> processorders()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span> o <span class="built_in">INT</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">DECLARE</span> ordernumbers <span class="keyword">CURSOR</span></span><br><span class="line">	<span class="keyword">FOR</span></span><br><span class="line">	<span class="keyword">SELECT</span> order_num <span class="keyword">FROM</span> orders;</span><br><span class="line">	</span><br><span class="line">	OPEN ordernumbers;</span><br><span class="line">	</span><br><span class="line">	FETCH ordernumbers INTO o;</span><br><span class="line">	</span><br><span class="line">	CLOSE ordernumbers;</span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">REPEAT</span><br><span class="line">	FETCH ordernumbers INTO o;</span><br><span class="line">UNTIL done <span class="keyword">END</span> <span class="keyword">REPEAT</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>加入条件语句的复杂版本</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> processorders()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span> done <span class="built_in">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">DECLARE</span> <span class="number">0</span> <span class="built_in">INT</span>;</span><br><span class="line">	<span class="keyword">DECLARE</span> t <span class="built_in">DECIMAL</span>(<span class="number">8</span>,<span class="number">2</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">DECLARE</span> ordernumbers <span class="keyword">CURSOR</span></span><br><span class="line">	<span class="keyword">FOR</span> <span class="keyword">SELECT</span> order_num <span class="keyword">FROM</span> orders;</span><br><span class="line">	<span class="keyword">DECLARE</span> CONTINUE <span class="keyword">HANDLER</span> <span class="keyword">FOR</span> <span class="keyword">SQLSTATE</span> <span class="string">'02000'</span> <span class="keyword">SET</span> done=<span class="number">1</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> EXITS ordertotals</span><br><span class="line">	<span class="keyword">OPEN</span> ordernumbers;</span><br><span class="line">	</span><br><span class="line">	REPEAT</span><br><span class="line">		FETCH orders INTO o;</span><br><span class="line">		<span class="keyword">CALL</span> ordertotal(o,<span class="number">1</span>,t)</span><br><span class="line">		<span class="keyword">INSERT</span> <span class="keyword">INTO</span> ordertotals(order_num, total)</span><br><span class="line">		<span class="keyword">VALUES</span>(o,t);</span><br><span class="line">		UNTIL done <span class="keyword">END</span> <span class="keyword">REPEAT</span>;</span><br><span class="line">		CLOSE ordernumbers;</span><br><span class="line">	<span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>
<h3 id="使用触发器"><a href="#使用触发器" class="headerlink" title="使用触发器"></a>使用触发器</h3><p>触发器是MySQL响应以下任意语句而自动执行的一条MySQL语句</p>
<ul>
<li>DELETE</li>
<li>INSERT</li>
<li>UPDATE</li>
</ul>
<h4 id="创建触发器"><a href="#创建触发器" class="headerlink" title="创建触发器"></a>创建触发器</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> newproduct <span class="keyword">AFTER</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> products</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">SELECT</span> <span class="string">'Product added'</span></span><br></pre></td></tr></table></figure>
<h4 id="删除触发器"><a href="#删除触发器" class="headerlink" title="删除触发器"></a>删除触发器</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> newproduct</span><br></pre></td></tr></table></figure>
<h4 id="INSERT触发器"><a href="#INSERT触发器" class="headerlink" title="INSERT触发器"></a>INSERT触发器</h4><ul>
<li>在INSERT触发器代码内，可引用一个名为NEW的虚拟表，访问被插入的行</li>
<li>在BEFORE INSERT触发器中，NEW中的值也可以被更新（允许更改被插入的值）</li>
<li>对于AUTO_INCREMENT列，NEW在INSERT执行之前包含0，在INSERT执行之后包含新的自动生成值</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> neworder <span class="keyword">AFTER</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> orders</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">SELECT</span> NEW.order_num</span><br></pre></td></tr></table></figure>
<h4 id="DELETE触发器"><a href="#DELETE触发器" class="headerlink" title="DELETE触发器"></a>DELETE触发器</h4><ul>
<li>在DELETE触发器代码内，你可以引用一个名为OLD的虚拟表，访问被删除的行</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> deleteorder <span class="keyword">BEFORE</span> <span class="keyword">DELETE</span> <span class="keyword">ON</span> orders</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line">	<span class="keyword">INSERT</span> <span class="keyword">INTO</span> archive_orders(order_num, order_date, cust_id)</span><br><span class="line">	<span class="keyword">VALUES</span>(OLD.order_num, OLD.order_date, OLD.cust_id)</span><br></pre></td></tr></table></figure>
<h4 id="UPDATE触发器"><a href="#UPDATE触发器" class="headerlink" title="UPDATE触发器"></a>UPDATE触发器</h4><ul>
<li>在UPDATE触发器代码中，你可以引用一个名为OLD的虚拟表访问以前（UPDATE语句前）的值，引用一个名为NEW的虚拟表访问新更新的值</li>
<li>在BEFORE UPDATE触发器中，NEW中的值可能也被更新（允许更改将要用于UPDATE语句中的值）</li>
<li>OLD中的值全都是只读的，不能更新</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> updatevendor <span class="keyword">BEFORE</span> <span class="keyword">UPDATE</span> <span class="keyword">ON</span> vendors</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">SET</span> NEW.vend_state = <span class="keyword">Upper</span>(NEW.vend_state)</span><br></pre></td></tr></table></figure>
<h3 id="使用事务管理"><a href="#使用事务管理" class="headerlink" title="使用事务管理"></a>使用事务管理</h3><p>事务处理可以用来维护数据库的完整性，它保证成批的MySQL操作要么完全执行，要么完全不执行</p>
<h4 id="标识事务的开始"><a href="#标识事务的开始" class="headerlink" title="标识事务的开始"></a>标识事务的开始</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> <span class="keyword">TRANSACTION</span></span><br></pre></td></tr></table></figure>
<h4 id="ROLLBACK回退SQL语句"><a href="#ROLLBACK回退SQL语句" class="headerlink" title="ROLLBACK回退SQL语句"></a>ROLLBACK回退SQL语句</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> ordertotals;</span><br><span class="line"><span class="keyword">START</span> <span class="keyword">TRANSACTION</span>;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> ordertotals;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> ordertotals;</span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line">SSELECT * FROM ordertotals;</span><br></pre></td></tr></table></figure>
<h4 id="使用COMMIT"><a href="#使用COMMIT" class="headerlink" title="使用COMMIT"></a>使用COMMIT</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> <span class="keyword">TRANSACTION</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> orderitems <span class="keyword">WHERE</span> order_num = <span class="number">20010</span>;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> order_num = <span class="number">20010</span>;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>
<h4 id="使用保留点"><a href="#使用保留点" class="headerlink" title="使用保留点"></a>使用保留点</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SAVEPOINT</span> delete1;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> delete1;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/11/雅思听力总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huangyt">
      <meta itemprop="description" content="Blogs of learning CS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/11/雅思听力总结/" class="post-title-link" itemprop="url">雅思听力总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-11 00:11:04" itemprop="dateCreated datePublished" datetime="2019-01-11T00:11:04+08:00">2019-01-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-07-19 16:42:15" itemprop="dateModified" datetime="2020-07-19T16:42:15+08:00">2020-07-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/雅思/" itemprop="url" rel="index"><span itemprop="name">雅思</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="听力"><a href="#听力" class="headerlink" title="听力"></a>听力</h2><h3 id="做题流程"><a href="#做题流程" class="headerlink" title="做题流程"></a>做题流程</h3><h4 id="读"><a href="#读" class="headerlink" title="读"></a>读</h4><ul>
<li>播放每段听力前有一段时间可以看题</li>
<li>看定位词：具体的难以替换的<strong>名词</strong></li>
<li>看限定词：e.g.best、today、in the festival…</li>
<li>用圈圈圈出可能被同义替换的词，用下划线画出定位词</li>
</ul>
<h4 id="猜"><a href="#猜" class="headerlink" title="猜"></a>猜</h4><ul>
<li>预判词性和内容，在每个空后面写出可能的词性（听的时候注意该词性的词）</li>
</ul>
<h4 id="听"><a href="#听" class="headerlink" title="听"></a>听</h4><ul>
<li>听到的词打勾（防止听飞了）</li>
<li>否定词是重点：e.g.without…</li>
<li>转折是重点：e.g.but、wait a minute…</li>
</ul>
<h4 id="写"><a href="#写" class="headerlink" title="写"></a>写</h4><ul>
<li>写的时候不用拼完整个单词，否则很容易漏掉下一题</li>
</ul>
<h4 id="查"><a href="#查" class="headerlink" title="查"></a>查</h4><ul>
<li>字数</li>
<li>词性</li>
<li>单复数</li>
<li>拼写</li>
</ul>
<h3 id="练习方法"><a href="#练习方法" class="headerlink" title="练习方法"></a>练习方法</h3><h4 id="精听"><a href="#精听" class="headerlink" title="精听"></a>精听</h4><ul>
<li>泛听一遍</li>
<li>总结：生词、连读、同义替换、答案规律</li>
<li>听写（理解文章80%后）<ul>
<li>听弱点</li>
<li>边听边记录（实词）&amp;听完理解意思后写（补虚词）</li>
<li>有干扰项的要整句听写<ul>
<li>选择题：整句听写</li>
<li>填空题：单词听写</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="跟读"><a href="#跟读" class="headerlink" title="跟读"></a>跟读</h4><p>先看懂原文，看懂但听不懂的再跟读</p>
<ul>
<li>第一遍：边听边读（不出声）</li>
<li>第二遍：听一句读一句（并录音）</li>
</ul>
<h3 id="题型"><a href="#题型" class="headerlink" title="题型"></a>题型</h3><h4 id="填空题"><a href="#填空题" class="headerlink" title="填空题"></a>填空题</h4><p>比较简单</p>
<ul>
<li>第一题会比较难听到</li>
<li>一般表示街道等名字的词是小学级别的词汇：e.g.Forrest Road</li>
</ul>
<h4 id="选择题"><a href="#选择题" class="headerlink" title="选择题"></a>选择题</h4><p>一般情况下，原文原词不会是正确答案，每个选项都会在原文中出现，但会做同义替换</p>
<ul>
<li>选项中难以被同义替换的词很可能不选：e.g.Monday,Thursday and Friday</li>
<li>不能听原文原词，要听<strong>同义替换</strong></li>
</ul>
<h4 id="表格题"><a href="#表格题" class="headerlink" title="表格题"></a>表格题</h4><ul>
<li>表头都是定位词</li>
</ul>
<h4 id="配对题"><a href="#配对题" class="headerlink" title="配对题"></a>配对题</h4><p>答案紧凑，如果迟疑很容易错过下一题</p>
<ul>
<li><p>要读开头的问句：有可能会设置陷阱</p>
</li>
<li><p>判断是选项/题干较有可能发生同义替换，决定看题重点</p>
</li>
<li><p>提纲式填空：S4主考题型</p>
<p>小标题是定位词，如果听飞了可以用小标题找回来</p>
</li>
<li><p>听的时候有几种写的方法，看情况使用</p>
<ul>
<li>正常写</li>
<li>将题号写在选项旁边</li>
<li>写关键词（一般不用）</li>
</ul>
</li>
<li><p>看题时可以合并同类项，如上升的用线连起来，下降的…</p>
</li>
<li><p>同义选项中更泛的一般不会选</p>
</li>
</ul>
<h4 id="地图题"><a href="#地图题" class="headerlink" title="地图题"></a>地图题</h4><h3 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h3><ul>
<li>-ty和-teen的区别：听<strong>重音</strong>的区别</li>
<li><strong>同义替换</strong>是重点！！</li>
<li><strong>状语从句</strong>可能发生<strong>答案前置</strong></li>
<li><p>听到类似between、range of时要注意范围</p>
</li>
<li><p>表示时间的格式：27,1,2017/December,27/27,December</p>
</li>
<li>表示街道：Road/Street/Drive/Lane/Avenue</li>
<li>A NUMBER 可以是数字+字母</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/10/计网总结（六）：无线网络/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huangyt">
      <meta itemprop="description" content="Blogs of learning CS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/10/计网总结（六）：无线网络/" class="post-title-link" itemprop="url">计网总结（六）：无线网络</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-10 22:58:08" itemprop="dateCreated datePublished" datetime="2019-01-10T22:58:08+08:00">2019-01-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-07-19 16:42:15" itemprop="dateModified" datetime="2020-07-19T16:42:15+08:00">2020-07-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/计算机网络/" itemprop="url" rel="index"><span itemprop="name">计算机网络</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="无线网络"><a href="#无线网络" class="headerlink" title="无线网络"></a>无线网络</h2><h4 id="无线链路的特征（与有线区别）"><a href="#无线链路的特征（与有线区别）" class="headerlink" title="无线链路的特征（与有线区别）"></a>无线链路的特征（与有线区别）</h4><ul>
<li>递减的信号强度：电磁波在穿过物体时强度减弱</li>
<li>来自其他源的干扰：同一频段发送信号的电波源将相互干扰</li>
<li>多路径传播：走了不同长度的路径</li>
</ul>
<h4 id="信噪比"><a href="#信噪比" class="headerlink" title="信噪比"></a>信噪比</h4><p>收到的信号和噪声强度的相对测量，较大的SNR使接收方更容易提取传输的信号</p>
<h4 id="802-11MAC协议"><a href="#802-11MAC协议" class="headerlink" title="802.11MAC协议"></a>802.11MAC协议</h4><p>无线LAN采用随机访问协议：带碰撞避免的CSMA（CSMA/CA）</p>
<p>802.11使用链路层确认/重传（ARQ）机制</p>
<h5 id="802-11未实现碰撞检测"><a href="#802-11未实现碰撞检测" class="headerlink" title="802.11未实现碰撞检测"></a>802.11未实现碰撞检测</h5><ul>
<li>接收信号的强度通常远远小于发送信号的强度，构建具有检测碰撞能力的硬件代价较大</li>
<li>适配器会由于隐藏终端问题和衰减问题无法检测到所有的碰撞</li>
</ul>
<h5 id="802-11的CSMA-CA协议"><a href="#802-11的CSMA-CA协议" class="headerlink" title="802.11的CSMA/CA协议"></a>802.11的CSMA/CA协议</h5><ul>
<li>若初始时某站点监听到信道空闲，在一个分布式帧间间隔（DIFS）的短时间段后发送该帧</li>
<li>否则，选取一个随机回退值并且在侦听信道空闲时递减该值，侦听到信道忙时，计数值保持不变</li>
<li>当计数值减为0时（只可能发生在信道被侦听为空闲时），站点发送整个数据帧并等待确认</li>
<li>若果收到确认，发送站知道它的帧已经被目的站接收了</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/10/计网总结（五）：链路层/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="huangyt">
      <meta itemprop="description" content="Blogs of learning CS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MyBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/10/计网总结（五）：链路层/" class="post-title-link" itemprop="url">计网总结（五）：链路层</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-10 22:50:42" itemprop="dateCreated datePublished" datetime="2019-01-10T22:50:42+08:00">2019-01-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-07-19 16:42:15" itemprop="dateModified" datetime="2020-07-19T16:42:15+08:00">2020-07-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/计算机网络/" itemprop="url" rel="index"><span itemprop="name">计算机网络</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="链路层"><a href="#链路层" class="headerlink" title="链路层"></a>链路层</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>链路层协议采取的动作包括差错检测、重传、流量控制和随机接入</p>
<p>链路层协议的任务：将网络层的数据报通过路径中的单端链路节点到节点地传送</p>
<p>数据报在不同的链路上可能由不同链路层协议所承载</p>
<h4 id="链路层能提供的服务"><a href="#链路层能提供的服务" class="headerlink" title="链路层能提供的服务"></a>链路层能提供的服务</h4><ul>
<li>成帧</li>
<li>链路接入</li>
<li>可靠交付通过确认和重传取得</li>
<li>流量控制</li>
<li>差错检测和纠正</li>
<li>半全工和双全工：可否同时传输和接收</li>
</ul>
<p>链路层的主体部分在网络适配器中实现，也称为网络接口卡</p>
<h3 id="差错检测和纠错"><a href="#差错检测和纠错" class="headerlink" title="差错检测和纠错"></a>差错检测和纠错</h3><p>比特级差错检测和纠错</p>
<h4 id="奇偶校验"><a href="#奇偶校验" class="headerlink" title="奇偶校验"></a>奇偶校验</h4><h5 id="奇检测"><a href="#奇检测" class="headerlink" title="奇检测"></a>奇检测</h5><p>包含一个附加比特，使得d+1个比特中1的总数总为奇数；偶检测相反</p>
<p>只能检测奇数个比特差错</p>
<h5 id="二维奇偶校验"><a href="#二维奇偶校验" class="headerlink" title="二维奇偶校验"></a>二维奇偶校验</h5><p>可以纠错单个比特差错，可以检测（但不能纠正）一个分组中两个比特差错的任何组合</p>
<h4 id="检验和方法"><a href="#检验和方法" class="headerlink" title="检验和方法"></a>检验和方法</h4><p>将k比特的整数加起来，并且用得到的和作为差错检测比特</p>
<h4 id="循环冗余检测"><a href="#循环冗余检测" class="headerlink" title="循环冗余检测"></a>循环冗余检测</h4><ul>
<li>r+1比特模式，R有r个比特</li>
<li>CRC采用模2算术操作，加法不进位减法不借位</li>
</ul>
<p>接收方检验：用G去除d+r，余数为0则无差错</p>
<h3 id="多路访问协议"><a href="#多路访问协议" class="headerlink" title="多路访问协议"></a>多路访问协议</h3><h4 id="信道划分协议"><a href="#信道划分协议" class="headerlink" title="信道划分协议"></a>信道划分协议</h4><h5 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h5><ul>
<li>时分多路复用（TDM）：将时间划分为时间帧，并进一步划分为N个时隙</li>
<li>频分多路复用（FDM）</li>
<li>码分多址（CDMA）：每个节点分配不同的编码</li>
</ul>
<h5 id="FDM、TDM的缺陷"><a href="#FDM、TDM的缺陷" class="headerlink" title="FDM、TDM的缺陷"></a>FDM、TDM的缺陷</h5><ul>
<li>节点被限制在R/N的平均速率，即使它为唯一有分组要发送的节点</li>
<li>节点必须总是等待它再传输序列中的轮次，即使它是唯一一个有帧要发送的节点</li>
</ul>
<h5 id="FDM、TDM优点"><a href="#FDM、TDM优点" class="headerlink" title="FDM、TDM优点"></a>FDM、TDM优点</h5><ul>
<li>避免碰撞、公平划分带宽</li>
</ul>
<h5 id="CMDA"><a href="#CMDA" class="headerlink" title="CMDA"></a>CMDA</h5><p>CDMA对每个节点只分配一种不同的编码，不同的节点能同时传输，互不干扰</p>
<h4 id="随机接入协议"><a href="#随机接入协议" class="headerlink" title="随机接入协议"></a>随机接入协议</h4><p>一个节点总是以信道的全部速率进行发送，有碰撞时，涉及碰撞的节点反复重发它的帧，直至无碰撞为止。但不是立刻重发，而是等待一个随机时延</p>
<h5 id="效率"><a href="#效率" class="headerlink" title="效率"></a>效率</h5><p>当有大量活跃节点且每个节点总有大量的帧要发送时，长期运行中成功时隙的份额</p>
<h5 id="时隙ALOHA"><a href="#时隙ALOHA" class="headerlink" title="时隙ALOHA"></a>时隙ALOHA</h5><p>如果有碰撞，节点在时隙结束之前检测到这次碰撞，以概率p在后续每个时隙中重传它的帧，直到该帧被无碰撞地传输出去</p>
<p>优点：只有一个活跃节点时工作出色</p>
<p>当有N个节点时其效率为Np(1-p)^(N-1)，最大效率约为1/2e(0.37)</p>
<h5 id="ALOHA"><a href="#ALOHA" class="headerlink" title="ALOHA"></a>ALOHA</h5><p>若发生碰撞，下一时隙以p概率重传该帧，以(1-p)概率等待一帧；等待之后如前</p>
<p>最大效率为1/2e</p>
<h5 id="载波侦听多路访问CSMA"><a href="#载波侦听多路访问CSMA" class="headerlink" title="载波侦听多路访问CSMA"></a>载波侦听多路访问CSMA</h5><ul>
<li>载波侦听：发送前先侦听，若空闲则发送，否则等待</li>
<li>碰撞检测：若碰撞则停止传输</li>
</ul>
<p>有碰撞检测的CSMA：CSMA/CD</p>
<p>由于存在信道传播时延，即使进行了载波侦听，仍可能出现碰撞。信道传输时延越大，载波侦听节点越可能不能侦听到网络中另一节点已开始传输</p>
<h4 id="轮流协议"><a href="#轮流协议" class="headerlink" title="轮流协议"></a>轮流协议</h4><h5 id="轮询协议"><a href="#轮询协议" class="headerlink" title="轮询协议"></a>轮询协议</h5><p>指定节点之一为主节点，主节点以循环的方式轮询每个节点</p>
<p>缺点：</p>
<ul>
<li>若只有一个节点时活跃的，主节点也必须依次轮询</li>
<li>若主节点有故障，整个信道不可操作</li>
</ul>
<h5 id="令牌传递协议"><a href="#令牌传递协议" class="headerlink" title="令牌传递协议"></a>令牌传递协议</h5><p>没有主节点，有帧要发送的节点才持有令牌，否则将令牌转发，效率高</p>
<p>缺点：一个节点的故障会使整个信道崩溃</p>
<h3 id="LANs"><a href="#LANs" class="headerlink" title="LANs"></a>LANs</h3><p>LAN：Local Area Network 局域网</p>
<h4 id="MAC地址"><a href="#MAC地址" class="headerlink" title="MAC地址"></a>MAC地址</h4><p>LAN地址、物理地址、MAC地址</p>
<p>同个子网下，数据链路层在网络适配器间传输数据使用的地址标识</p>
<p>长度6个字节，每个字节为一对16进制数，具有扁平结构（所以具备可迁移性）</p>
<p>MAC广播地址：FF-FF-FF-FF-FF-FF</p>
<h4 id="地址解析协议ARP"><a href="#地址解析协议ARP" class="headerlink" title="地址解析协议ARP"></a>地址解析协议ARP</h4><p>将网络层地址转换为链路层地址</p>
<p>每个节点（主机或路由器）的ARP模块都有一个ARP表</p>
<h5 id="DNS和ARP的区别"><a href="#DNS和ARP的区别" class="headerlink" title="DNS和ARP的区别"></a>DNS和ARP的区别</h5><p>DNS为因特网中任何地方的主机解析主机名，但ARP只为同一个子网下的节点解析IP地址</p>
<h5 id="ARP表"><a href="#ARP表" class="headerlink" title="ARP表"></a>ARP表</h5><table>
<thead>
<tr>
<th>IP地址</th>
<th>MAC地址</th>
<th>TTL</th>
</tr>
</thead>
<tbody>
<tr>
<td>222.222.222.221</td>
<td>88-B2-2F-54-1A-0F</td>
<td>13:45:00</td>
</tr>
</tbody>
</table>
<p>生存期（TTL）：从表中删除每个映射的时间</p>
<h5 id="ARP寻址的过程"><a href="#ARP寻址的过程" class="headerlink" title="ARP寻址的过程"></a>ARP寻址的过程</h5><ul>
<li>发送节点构造并广播ARP查询分组，其中包括发送节点和接受节点的MAC地址和IP地址（接受节点的MAC地址为广播地址）</li>
<li>子网中的适配器接收后，向上传递给节点中的ARP模块，检查IP地址是否与ARP分组中的匹配</li>
<li>一个匹配的节点给查询节点发送回一个响应ARP分组</li>
<li>发送节点更新ARP表</li>
</ul>
<h5 id="发送数据报到子网以外的节点"><a href="#发送数据报到子网以外的节点" class="headerlink" title="发送数据报到子网以外的节点"></a>发送数据报到子网以外的节点</h5><p>源IP地址，源MAC地址：主机的IP地址和MAC地址</p>
<p>目的IP地址，目的MAC地址：目的主机IP地址，网关的MAC地址（路由器响应接口的MAC地址）</p>
<p>若直接使用目的主机的MAC地址，子网中的适配器都不会将其传递到网络层，因为该帧的目的地址都不与子网中适配器的MAC地址匹配</p>
<p>具体过程：</p>
<ul>
<li>主机通过ARP获取通往目的子网的路由器与本地网相连端口的MAC地址，创建帧并将其放入子网中</li>
<li>路由器接收该帧，并将数据报交付给网络层，查询转发表，获取转发接口后，将数据转发到该接口</li>
<li>接口将数据报交付给其适配器，适配器将数据报封装到一个新的帧中，该帧的目的地址为最终目的地址的MAC地址（MAC地址通过ARP获得），同时源MAC地址为此时适配器的MAC地址</li>
</ul>
<h4 id="以太网"><a href="#以太网" class="headerlink" title="以太网"></a>以太网</h4><p>提供无连接、不可靠服务</p>
<h5 id="以太网帧结构"><a href="#以太网帧结构" class="headerlink" title="以太网帧结构"></a>以太网帧结构</h5><ul>
<li>数据字段 46-1500字节：以太网最大传输单元（MTU）为1500字节，数据段最小长度为46字节，如果不足需要填充</li>
<li>目的地址 6字节：目的适配器的MAC地址</li>
<li>源地址 6字节：传输该帧到LAN上的适配器的MAC地址</li>
<li>类型字段 2字节：允许以太网复用多种网络协议</li>
<li>循环冗余检测CRC 4字节：目的是使得接收适配器检测帧中是否进入了差错</li>
<li>前同步码 8字节：前七个字节为10101010，最后一个字节为10101011，用于唤醒接收适配器，同步其时钟与发送方时钟</li>
</ul>
<h5 id="CSMA-CD"><a href="#CSMA-CD" class="headerlink" title="CSMA/CD"></a>CSMA/CD</h5><p>以太网的多路访问协议</p>
<p>CSMA/CD机制：</p>
<ul>
<li>适配器可以在任何时刻开始传输，没有时隙概念</li>
<li>载波侦听：当适配器侦听到有其他适配器正在传输，不传输帧</li>
<li>碰撞检测：当传输中的适配器检测到有其他适配器正在传输，终止传输</li>
<li>重传前适配器等待一个随机时间，通常比传输一帧的时间短</li>
</ul>
<p>CSMA/CD工作方式：</p>
<ul>
<li>适配器从网络层得到一个数据报，准备一个以太网帧并放到适配器缓存区中</li>
<li>若适配器侦听到信道空闲，开始传输</li>
<li>传输过程中监视来自其他适配器的信号能量</li>
<li>如果检测到来自其他适配器的信号能量，停止传输</li>
<li>中止后适配器进入<strong>指数后退</strong>阶段，在该帧经受了n次连续碰撞后，适配器随机从{0,1,2,…,2^m-1}为K选择一个值，m=min{n,10}，适配器等待K*512比特时间，返回第二步（随机、指数增长的上界）</li>
</ul>
<h5 id="以太网效率"><a href="#以太网效率" class="headerlink" title="以太网效率"></a>以太网效率</h5><p>网线越长，效率越低</p>
<h4 id="交换机"><a href="#交换机" class="headerlink" title="交换机"></a>交换机</h4><p>交换机是即插即用设备</p>
<h5 id="交换机功能"><a href="#交换机功能" class="headerlink" title="交换机功能"></a>交换机功能</h5><ul>
<li><p>过滤：决定一个帧应该转发还是丢弃</p>
</li>
<li><p>转发：决定一个帧应该被导向哪个接口，并移动帧</p>
</li>
<li><p>借助交换机表完成，交换机表：</p>
<p>| MAC地址           | 到达节点的交换机接口 | 表项放置在表中的时间 |<br>| —————– | ——————– | ——————– |<br>| 62-FE-F7-11-89-A3 | 1                    | 9:32                 |</p>
</li>
</ul>
<h5 id="交换机工作过程"><a href="#交换机工作过程" class="headerlink" title="交换机工作过程"></a>交换机工作过程</h5><p>假定有目的地址DD-DD-DD-DD-DD-DD的帧从交换机接口x到达</p>
<ul>
<li>若表中没有DD-DD-DD-DD-DD-DD的表项，交换机广播该帧</li>
<li>若存在表项将DD-DD-DD-DD-DD-DD与接口x联系起来，交换机丢弃该帧（过滤功能）</li>
<li>若存在表项将DD-DD-DD-DD-DD-DD与接口y（!= x）联系起来，交换机将该帧转发到y接口，并将信息添加到表项中</li>
</ul>
<h5 id="自学习"><a href="#自学习" class="headerlink" title="自学习"></a>自学习</h5><ul>
<li>交换机表初始为空</li>
<li>对于接口收到的每个帧，交换机在其表中记录<ul>
<li>该帧源地址字段中的MAC地址</li>
<li>该帧到达的接口</li>
<li>当前的时间</li>
</ul>
</li>
<li>接下来一段时间（老化期）中，交换机没有接收到以该址为源地址的帧，则删除该地址</li>
</ul>
<h5 id="交换机的性质"><a href="#交换机的性质" class="headerlink" title="交换机的性质"></a>交换机的性质</h5><ul>
<li>消除碰撞</li>
<li>异质的链路：交换机将链路彼此隔离</li>
<li>管理</li>
</ul>
<h5 id="交换机和路由器的比较"><a href="#交换机和路由器的比较" class="headerlink" title="交换机和路由器的比较"></a>交换机和路由器的比较</h5><ul>
<li>由于交换机只需要查看二层数据帧 的头部即可决策转发地址，策略十分简单，可以直接通过硬件芯片实现相应功能，所以可以做到廉价高速，被大量应用在接入层。</li>
<li>而路由器由于需要处理跨网络的连接，必须在接收到完整的 IP数据包 后才能转发数据，路由协议又比较复杂，所以只能使用软件的方式实现相应的功能，要达到高性能只能付出更高的价格</li>
<li>交换机的优缺点<ul>
<li>优点：即插即用；具有相对高的分组过滤和转发速率</li>
<li>缺点：对广播风暴不提供保护措施</li>
</ul>
</li>
<li>路由器的优缺点<ul>
<li>优点：即使网络存在冗余路径，分组也不会通过路由器循环；对第二层的广播风暴提供了防火墙保护</li>
<li>缺点：非即插即用；处理时间较长</li>
</ul>
</li>
</ul>
<h4 id="PPP"><a href="#PPP" class="headerlink" title="PPP"></a>PPP</h4><p>高级数据链路控制协议（HDLC）</p>
<h5 id="PPP数据成帧"><a href="#PPP数据成帧" class="headerlink" title="PPP数据成帧"></a>PPP数据成帧</h5><ul>
<li>标志 1字节</li>
<li>地址 1字节</li>
<li>控制 1字节</li>
<li>协议 1或2字节</li>
<li>信息 可变长度</li>
<li>检验和 2或4字节</li>
<li>标志 1字节</li>
</ul>
<h4 id="VLAN"><a href="#VLAN" class="headerlink" title="VLAN"></a>VLAN</h4><p>局域网缺点</p>
<ul>
<li>缺乏流量隔离</li>
<li>交换机的无效使用</li>
<li>管理用户</li>
</ul>
<p>支持VLAN的交换机允许经一个单一的物理局域网基础设施定义多个虚拟局域网</p>
<h3 id="多协议标签交换MPLS"><a href="#多协议标签交换MPLS" class="headerlink" title="多协议标签交换MPLS"></a>多协议标签交换MPLS</h3><h4 id="MPLS首部"><a href="#MPLS首部" class="headerlink" title="MPLS首部"></a>MPLS首部</h4><p>标签、实验、S、TTL</p>
<h3 id="Web请求"><a href="#Web请求" class="headerlink" title="Web请求"></a>Web请求</h3><p>DHCP（UDP）、AQP、DNS（UDP）、HTTP、FTP</p>
<p>RIP/OSPF、BGP</p>
<p>详见PPT 或 课本p330</p>
<h4 id="DHCP"><a href="#DHCP" class="headerlink" title="DHCP"></a>DHCP</h4><ul>
<li>DHCP请求报文 生成UDP报文段 放入以太网帧 广播</li>
<li>被分解 CIDR分配地址 收到DHCPACK</li>
</ul>
<h4 id="ARP"><a href="#ARP" class="headerlink" title="ARP"></a>ARP</h4><ul>
<li>DNS查询报文</li>
<li>ARP查询报文查询网关路由器MAC地址</li>
<li>ARP回答，获取网关路由器的MAC地址</li>
</ul>
<h4 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h4><ul>
<li>网关路由器接收转发 通过域内协议和域间协议BGP</li>
<li>找到DNS源记录 查询权威DNS 生成DNS回答报文 放入UDP IP数据报 </li>
</ul>
<h4 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h4><ul>
<li>生成TCP套接字</li>
<li>三次握手：TCPSYN报文段 TCPSYNACK报文段</li>
</ul>
<h4 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h4><ul>
<li>HTTP请求 HTTP GET报文</li>
<li>服务器生成HTTP响应报文 放入请求内容 发送到TCP套接字</li>
<li>获取响应 渲染</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">huangyt</p>
  <div class="site-description" itemprop="description">Blogs of learning CS</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">15</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/huangyt39" title="GitHub → https://github.com/huangyt39" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:huangyt39@163.com" title="E-Mail → mailto:huangyt39@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">huangyt</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

</body>
</html>
